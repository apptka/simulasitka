<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulasi TKA - Mode Guru & Murid</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS tetap sama seperti sebelumnya (tidak diubah) */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f0f7ff; color: #333; line-height: 1.6; padding: 20px; background-image: linear-gradient(to bottom right, #e6f0ff, #f9fbff); }
        .container { max-width: 1200px; margin: 0 auto; background-color: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 100, 200, 0.15); overflow: hidden; }
        header { background: linear-gradient(135deg, #1a6dcc, #0d4d9c); color: white; padding: 25px 30px; text-align: center; position: relative; overflow: hidden; }
        header h1 { font-size: 28px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 15px; position: relative; z-index: 1; }
        .user-info { background-color: rgba(255, 255, 255, 0.2); padding: 12px 20px; border-radius: 10px; margin-top: 15px; display: inline-block; font-size: 16px; position: relative; z-index: 1; backdrop-filter: blur(5px); }
        .logo { font-size: 32px; }
        .app-container { display: flex; min-height: 700px; }
        .sidebar { width: 280px; background-color: #f8fbff; padding: 25px 20px; border-right: 1px solid #e1ecff; position: relative; z-index: 1; }
        .mode-selector { background-color: white; padding: 15px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 3px 10px rgba(0,0,0,0.05); border: 1px solid #e1ecff; }
        .mode-selector h4 { color: #1a6dcc; margin-bottom: 10px; font-size: 16px; }
        .mode-buttons { display: flex; gap: 10px; }
        .mode-btn { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #d1e3ff; background-color: white; color: #555; font-size: 14px; cursor: pointer; transition: all 0.3s; text-align: center; }
        .mode-btn:hover { background-color: #f0f7ff; }
        .mode-btn.active { background-color: #1a6dcc; color: white; border-color: #1a6dcc; }
        .menu-item { padding: 15px; margin-bottom: 10px; border-radius: 10px; cursor: pointer; transition: all 0.3s; font-weight: 500; display: flex; align-items: center; gap: 10px; position: relative; }
        .menu-item:hover { background-color: #e6f0ff; }
        .menu-item.active { background-color: #1a6dcc; color: white; }
        .menu-item i { font-size: 18px; }
        .main-content { flex: 1; padding: 30px; position: relative; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        h2 { color: #1a6dcc; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e6f0ff; display: flex; align-items: center; gap: 10px; }
        .welcome-screen p { margin-bottom: 20px; font-size: 16px; }
        .class-selection { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; margin-top: 30px; }
        .class-card { background-color: #f8fbff; border-radius: 15px; padding: 25px 20px; text-align: center; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; position: relative; overflow: hidden; }
        .class-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(26, 109, 204, 0.15); border-color: #1a6dcc; }
        .class-card.selected { background-color: #e6f0ff; border-color: #1a6dcc; transform: translateY(-5px); box-shadow: 0 10px 20px rgba(26, 109, 204, 0.15); }
        .class-card i { font-size: 50px; margin-bottom: 20px; color: #1a6dcc; }
        .class-card h3 { margin-bottom: 10px; color: #0d4d9c; font-size: 22px; }
        .class-info { font-size: 14px; color: #666; margin-bottom: 15px; }
        .subject-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 30px; }
        .subject-card { background-color: #f8fbff; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; }
        .subject-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(26, 109, 204, 0.1); border-color: #1a6dcc; }
        .subject-card i { font-size: 40px; margin-bottom: 15px; color: #1a6dcc; }
        .subject-card h3 { margin-bottom: 10px; color: #0d4d9c; }
        .subject-info { font-size: 14px; color: #666; }
        .timer-box { background-color: #f0f7ff; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 25px; border: 1px solid #d1e3ff; display: flex; justify-content: space-between; align-items: center; }
        .timer-section { flex: 1; }
        .timer { font-size: 28px; font-weight: bold; color: #1a6dcc; margin: 10px 0; }
        .question-counter { font-size: 16px; color: #666; }
        .progress-bar { height: 8px; background-color: #e1ecff; border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .progress { height: 100%; background-color: #1a6dcc; width: 0%; transition: width 0.3s; }
        .question-box { background-color: #f8fbff; padding: 25px; border-radius: 10px; margin-bottom: 25px; border-left: 5px solid #1a6dcc; }
        .question-text { font-size: 18px; margin-bottom: 25px; font-weight: 500; }
        .options { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .option { padding: 15px; background-color: white; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: 2px solid #e1ecff; display: flex; align-items: center; gap: 15px; }
        .option:hover { background-color: #f0f7ff; }
        .option.selected { background-color: #e6f0ff; border-color: #1a6dcc; }
        .option.correct { background-color: #e8f5e9; border-color: #4CAF50; }
        .option.incorrect { background-color: #ffebee; border-color: #f44336; }
        .option-label { width: 30px; height: 30px; border-radius: 50%; background-color: #e6f0ff; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #1a6dcc; flex-shrink: 0; }
        .option.selected .option-label { background-color: #1a6dcc; color: white; }
        .navigation { display: flex; justify-content: space-between; margin-top: 30px; }
        button { padding: 12px 25px; border: none; border-radius: 8px; background-color: #1a6dcc; color: white; font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 10px; }
        button:hover { background-color: #0d4d9c; transform: translateY(-2px); }
        button.secondary { background-color: #f0f7ff; color: #1a6dcc; }
        button.secondary:hover { background-color: #e1ecff; }
        button:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }
        .result-summary { background-color: #f8fbff; padding: 25px; border-radius: 10px; margin-bottom: 25px; }
        .score-display { text-align: center; margin: 30px 0; }
        .score-circle { width: 150px; height: 150px; border-radius: 50%; background: conic-gradient(#4CAF50 0% 70%, #ff9800 70% 85%, #f44336 85% 100%); margin: 0 auto 30px; display: flex; align-items: center; justify-content: center; position: relative; }
        .score-inner { width: 120px; height: 120px; border-radius: 50%; background-color: white; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold; color: #1a6dcc; }
        .subject-results { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 30px; }
        .subject-result { background-color: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 3px 10px rgba(0,0,0,0.05); }
        .subject-result i { font-size: 30px; margin-bottom: 15px; color: #1a6dcc; }
        .result-details { margin-top: 30px; max-height: 400px; overflow-y: auto; }
        .detail-item { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #e6f0ff; }
        .detail-item:last-child { border-bottom: none; }
        .correct { color: #4CAF50; font-weight: bold; }
        .incorrect { color: #f44336; font-weight: bold; }
        .skipped { color: #ff9800; font-weight: bold; }
        footer { text-align: center; padding: 20px; color: #666; font-size: 14px; border-top: 1px solid #e1ecff; margin-top: 30px; }
        .instructions { background-color: #f8fbff; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .instructions h3 { margin-bottom: 10px; color: #1a6dcc; }
        .instructions ul { margin-left: 20px; }
        .instructions li { margin-bottom: 8px; }
        .login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; min-height: 400px; }
        .login-screen h2 { margin-bottom: 30px; }
        .login-input { width: 100%; max-width: 400px; padding: 15px; font-size: 16px; border: 2px solid #d1e3ff; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .login-input:focus { outline: none; border-color: #1a6dcc; }
        .question-numbers { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; justify-content: center; max-height: 120px; overflow-y: auto; }
        .question-number { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background-color: white; border: 2px solid #e1ecff; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .question-number:hover { background-color: #f0f7ff; }
        .question-number.answered { background-color: #e6f0ff; border-color: #1a6dcc; color: #1a6dcc; }
        .question-number.current { background-color: #1a6dcc; color: white; border-color: #1a6dcc; }
        .assistant-panel { background-color: #f0f7ff; border-radius: 10px; padding: 20px; margin-top: 25px; border-left: 5px solid #ff9800; display: none; }
        .assistant-panel.show { display: block; animation: slideIn 0.5s; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .assistant-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; color: #0d4d9c; }
        .assistant-header i { font-size: 24px; color: #ff9800; }
        .assistant-content { line-height: 1.7; }
        .hint-btn { background-color: #ff9800; margin-top: 15px; }
        .hint-btn:hover { background-color: #e68900; }
        .class-progress { display: flex; justify-content: space-between; margin-top: 20px; padding-top: 15px; border-top: 1px solid #e1ecff; }
        .progress-item { text-align: center; flex: 1; }
        .progress-value { font-size: 24px; font-weight: bold; color: #1a6dcc; }
        .progress-label { font-size: 14px; color: #666; }
        .teacher-dashboard { padding: 20px; }
        .teacher-stats { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background-color: #f8fbff; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 3px 10px rgba(0,0,0,0.05); }
        .stat-card i { font-size: 30px; color: #1a6dcc; margin-bottom: 15px; }
        .stat-value { font-size: 28px; font-weight: bold; color: #1a6dcc; margin: 10px 0; }
        .stat-label { font-size: 14px; color: #666; }
        .student-list { background-color: white; border-radius: 10px; overflow: hidden; box-shadow: 0 3px 15px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .student-header { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; background-color: #1a6dcc; color: white; padding: 15px; font-weight: bold; }
        .student-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; padding: 15px; border-bottom: 1px solid #e6f0ff; align-items: center; }
        .student-row:hover { background-color: #f8fbff; }
        .student-row:last-child { border-bottom: none; }
        .student-name { font-weight: 500; }
        .student-score { text-align: center; font-weight: bold; }
        .student-score.high { color: #4CAF50; }
        .student-score.medium { color: #FF9800; }
        .student-score.low { color: #F44336; }
        .school-management { background-color: #f8fbff; padding: 25px; border-radius: 10px; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #0d4d9c; }
        .form-control { width: 100%; padding: 12px; border: 2px solid #d1e3ff; border-radius: 8px; font-size: 16px; }
        .form-control:focus { outline: none; border-color: #1a6dcc; }
        .form-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .form-row .form-group { flex: 1; }
        .action-buttons { display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap; }
        .school-code { background-color: white; padding: 15px; border-radius: 8px; margin-top: 15px; border: 2px dashed #1a6dcc; text-align: center; font-size: 18px; font-weight: bold; color: #1a6dcc; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .alert.success { background-color: #e8f5e9; border: 1px solid #4CAF50; color: #2e7d32; }
        .alert.error { background-color: #ffebee; border: 1px solid #f44336; color: #c62828; }
        .alert.warning { background-color: #fff3e0; border: 1px solid #ff9800; color: #ef6c00; }
        .alert.show { display: block; animation: fadeIn 0.5s; }
        .filter-options { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-select { padding: 10px 15px; border: 2px solid #d1e3ff; border-radius: 8px; background-color: white; font-size: 14px; min-width: 150px; }
        .export-btn { background-color: #4CAF50; }
        .export-btn:hover { background-color: #388e3c; }
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; border-right: none; border-bottom: 1px solid #e1ecff; }
            .subject-list, .class-selection { grid-template-columns: 1fr; }
            .timer-box { flex-direction: column; gap: 15px; }
            .question-numbers { max-height: 150px; }
            .student-header, .student-row { grid-template-columns: 1fr; text-align: center; gap: 10px; }
            .form-row { flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-graduation-cap logo"></i> Simulasi TKA - Mode Guru & Murid</h1>
            <p>Sistem pembelajaran dan penilaian terintegrasi untuk guru dan siswa</p>
            <div class="user-info" id="user-info" style="display: none;">
                <i class="fas fa-user"></i> 
                <span id="user-role-display">-</span> | 
                <span id="user-school-display">-</span>
                <span id="user-name-display" style="display: none;"> | Nama: <span id="user-name-value">-</span></span>
            </div>
        </header>
        
        <div class="app-container">
            <div class="sidebar" id="sidebar" style="display: none;">
                <div class="mode-selector" id="mode-selector"></div>
                <div id="menu-items"></div>
            </div>
            
            <div class="main-content">
                <!-- Layar Pilih Mode -->
                <div class="screen active" id="mode-selection">
                    <div class="login-screen">
                        <h2><i class="fas fa-users"></i> Pilih Mode Pengguna</h2>
                        <p>Silakan pilih mode yang sesuai dengan peran Anda dalam sistem ini.</p>
                        <div class="class-selection">
                            <div class="class-card" data-mode="student">
                                <i class="fas fa-user-graduate"></i>
                                <h3>Mode Murid</h3>
                                <p class="class-info">Untuk siswa yang ingin mengikuti simulasi TKA</p>
                                <div class="progress-label">Mengerjakan soal & melihat nilai</div>
                            </div>
                            <div class="class-card" data-mode="teacher">
                                <i class="fas fa-chalkboard-teacher"></i>
                                <h3>Mode Guru</h3>
                                <p class="class-info">Untuk guru yang ingin mengelola sekolah dan melihat nilai siswa</p>
                                <div class="progress-label">Kelola sekolah & pantau nilai</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Layar Login Murid -->
                <div class="screen" id="student-login">
                    <div class="login-screen">
                        <h2><i class="fas fa-sign-in-alt"></i> Login Murid</h2>
                        <p>Masukkan data diri Anda untuk mengakses simulasi TKA</p>
                        <div class="alert" id="student-alert"></div>
                        <input type="text" class="login-input" id="student-school-input" placeholder="Masukkan Nama Sekolah" maxlength="100">
                        <input type="text" class="login-input" id="student-name-input" placeholder="Masukkan Nama Lengkap" maxlength="50">
                        <input type="text" class="login-input" id="student-code-input" placeholder="Masukkan Kode Sekolah (opsional)" maxlength="10">
                        <div class="action-buttons">
                            <button class="secondary" id="back-to-mode"><i class="fas fa-arrow-left"></i> Kembali</button>
                            <button id="student-login-btn"><i class="fas fa-sign-in-alt"></i> Masuk</button>
                        </div>
                    </div>
                </div>
                
                <!-- Layar Login/Daftar Guru -->
                <div class="screen" id="teacher-login">
                    <div class="login-screen">
                        <h2><i class="fas fa-sign-in-alt"></i> Login / Daftar Guru</h2>
                        <p>Masuk dengan akun guru yang sudah ada atau daftarkan sekolah baru</p>
                        <div class="alert" id="teacher-alert"></div>
                        <div class="form-row">
                            <div class="form-group">
                                <input type="text" class="login-input" id="teacher-school-input" placeholder="Nama Sekolah" maxlength="100">
                            </div>
                            <div class="form-group">
                                <input type="password" class="login-input" id="teacher-password-input" placeholder="Password Guru" maxlength="50">
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="secondary" id="back-to-mode2"><i class="fas fa-arrow-left"></i> Kembali</button>
                            <button id="teacher-login-btn"><i class="fas fa-sign-in-alt"></i> Login Guru</button>
                            <button class="secondary" id="teacher-register-btn"><i class="fas fa-plus-circle"></i> Daftar Sekolah Baru</button>
                        </div>
                    </div>
                </div>
                
                <!-- Dashboard Guru -->
                <div class="screen" id="teacher-dashboard">
                    <div class="teacher-dashboard">
                        <h2><i class="fas fa-tachometer-alt"></i> Dashboard Guru</h2>
                        <div class="alert" id="teacher-dashboard-alert"></div>
                        <div class="teacher-stats">
                            <div class="stat-card"><i class="fas fa-school"></i><div class="stat-value" id="stat-school-name">-</div><div class="stat-label">Nama Sekolah</div></div>
                            <div class="stat-card"><i class="fas fa-user-graduate"></i><div class="stat-value" id="stat-total-students">0</div><div class="stat-label">Total Murid</div></div>
                            <div class="stat-card"><i class="fas fa-clipboard-check"></i><div class="stat-value" id="stat-total-tests">0</div><div class="stat-label">Total Tes Diselesaikan</div></div>
                            <div class="stat-card"><i class="fas fa-chart-line"></i><div class="stat-value" id="stat-average-score">0</div><div class="stat-label">Rata-rata Nilai</div></div>
                        </div>
                        <div class="school-management">
                            <h3><i class="fas fa-cog"></i> Kelola Sekolah</h3>
                            <div class="form-group">
                                <label>Kode Sekolah (berikan ke murid untuk bergabung)</label>
                                <div class="school-code" id="school-code-display">-</div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nama Sekolah</label>
                                    <input type="text" class="form-control" id="edit-school-name" placeholder="Nama Sekolah">
                                </div>
                                <div class="form-group">
                                    <label>Password Guru</label>
                                    <input type="password" class="form-control" id="edit-teacher-password" placeholder="Password Baru (kosongkan jika tidak diubah)">
                                </div>
                            </div>
                            <div class="action-buttons">
                                <button id="update-school-btn"><i class="fas fa-save"></i> Perbarui Data Sekolah</button>
                                <button class="secondary" id="export-data-btn"><i class="fas fa-download"></i> Ekspor Data Nilai</button>
                            </div>
                        </div>
                        <h3><i class="fas fa-list-alt"></i> Daftar Nilai Murid</h3>
                        <div class="filter-options">
                            <select class="filter-select" id="filter-class">
                                <option value="all">Semua Kelas</option>
                                <option value="6sd">Kelas 6 SD</option>
                                <option value="2smp">Kelas 2 SMP</option>
                                <option value="3smp">Kelas 3 SMP</option>
                            </select>
                            <select class="filter-select" id="filter-subject">
                                <option value="all">Semua Mata Pelajaran</option>
                                <option value="matematika">Matematika</option>
                                <option value="ipa">IPA</option>
                                <option value="bahasa-indonesia">Bahasa Indonesia</option>
                                <option value="english">Bahasa Inggris</option>
                            </select>
                            <select class="filter-select" id="filter-sort">
                                <option value="name">Urutkan Nama</option>
                                <option value="score-desc">Nilai Tertinggi</option>
                                <option value="score-asc">Nilai Terendah</option>
                                <option value="date-desc">Terbaru</option>
                            </select>
                            <button class="secondary" id="refresh-dashboard-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
                        </div>
                        <div class="student-list">
                            <div class="student-header">
                                <div>Nama Murid</div>
                                <div>Kelas</div>
                                <div>Mata Pelajaran</div>
                                <div>Nilai</div>
                                <div>Tanggal</div>
                            </div>
                            <div id="student-results-list">
                                <div class="student-row" style="text-align: center; padding: 40px;">
                                    <div style="grid-column: 1 / span 5;">Belum ada data nilai murid</div>
                                </div>
                            </div>
                        </div>
                        <div class="navigation">
                            <button class="secondary" id="teacher-logout-btn"><i class="fas fa-sign-out-alt"></i> Keluar</button>
                        </div>
                    </div>
                </div>
                
                <!-- Layar Pilih Kelas Murid -->
                <div class="screen" id="class-selection">
                    <h2><i class="fas fa-graduation-cap"></i> Pilih Tingkat Kelas</h2>
                    <p>Hai, <span id="class-selection-name"></span>! Silakan pilih tingkat kelas yang sesuai dengan Anda.</p>
                    <div class="class-selection">
                        <div class="class-card" data-class="6sd"><i class="fas fa-child"></i><h3>Kelas 6 SD</h3><p class="class-info">Materi dasar Matematika, IPA, Bahasa Indonesia</p><div class="progress-label">15 soal per pelajaran</div></div>
                        <div class="class-card" data-class="2smp"><i class="fas fa-user-graduate"></i><h3>Kelas 2 SMP</h3><p class="class-info">Materi menengah dengan tambahan Bahasa Inggris</p><div class="progress-label">15 soal per pelajaran</div></div>
                        <div class="class-card" data-class="3smp"><i class="fas fa-user-graduate"></i><h3>Kelas 3 SMP</h3><p class="class-info">Materi lanjutan untuk persiapan ujian</p><div class="progress-label">15 soal per pelajaran</div></div>
                    </div>
                    <div class="navigation">
                        <button class="secondary" id="back-to-student-login"><i class="fas fa-arrow-left"></i> Kembali</button>
                        <button id="confirm-class"><i class="fas fa-check"></i> Konfirmasi Pilihan</button>
                    </div>
                </div>
                
                <!-- Layar Beranda Murid -->
                <div class="screen" id="welcome">
                    <h2><i class="fas fa-door-open"></i> Selamat Datang, <span id="welcome-name"></span></h2>
                    <p>Hai, <span id="welcome-name2"></span>! Anda berada di <strong id="welcome-class"></strong> di <strong id="welcome-school"></strong>. 
                    Aplikasi ini akan membantu kamu mempersiapkan diri menghadapi Tes Kompetensi Akademik (TKA).</p>
                    <div class="instructions">
                        <h3><i class="fas fa-info-circle"></i> Petunjuk Penggunaan:</h3>
                        <ul>
                            <li>Pilih mata pelajaran yang ingin kamu pelajari</li>
                            <li>Setiap tes terdiri dari <strong>15 soal</strong> pilihan ganda</li>
                            <li>Mode <strong>Simulasi</strong>: Tes dengan timer seperti ujian sesungguhnya</li>
                            <li>Mode <strong>Belajar</strong>: Dapatkan bantuan asisten dan pembahasan soal</li>
                            <li>Jawaban bisa diubah selama tes masih berlangsung</li>
                            <li>Hasil akan ditampilkan setelah tes selesai dan tersimpan di sistem sekolah</li>
                        </ul>
                    </div>
                    <div class="class-progress">
                        <div class="progress-item"><div class="progress-value" id="total-progress">0%</div><div class="progress-label">Total Progress</div></div>
                        <div class="progress-item"><div class="progress-value" id="average-score">0</div><div class="progress-label">Rata-rata Nilai</div></div>
                        <div class="progress-item"><div class="progress-value" id="completed-tests">0</div><div class="progress-label">Tes Selesai</div></div>
                    </div>
                    <h3><i class="fas fa-history"></i> Riwayat Nilai Terakhir</h3>
                    <div class="subject-results" id="history-results"></div>
                    <h3 style="margin-top: 30px;"><i class="fas fa-book-open"></i> Pilih Mata Pelajaran</h3>
                    <div class="subject-list" id="subject-list"></div>
                    <div class="navigation" style="margin-top: 30px;">
                        <button class="secondary" id="student-logout-btn"><i class="fas fa-sign-out-alt"></i> Keluar</button>
                    </div>
                </div>
                
                <!-- Layar Tes Matematika -->
                <div class="screen" id="matematika">
                    <h2><i class="fas fa-calculator"></i> Tes Matematika</h2>
                    <div class="timer-box">
                        <div class="timer-section">
                            <div>Waktu Tersisa:</div>
                            <div class="timer" id="matematika-timer">30:00</div>
                            <div class="question-counter">Soal <span id="matematika-current">1</span> dari 15</div>
                            <div class="progress-bar"><div class="progress" id="matematika-progress"></div></div>
                        </div>
                        <div class="question-numbers" id="matematika-numbers"></div>
                    </div>
                    <div class="question-box">
                        <div class="question-text" id="matematika-question"></div>
                        <div class="options" id="matematika-options"></div>
                    </div>
                    <div class="assistant-panel" id="matematika-assistant">
                        <div class="assistant-header"><i class="fas fa-robot"></i><h4>Asisten Matematika</h4></div>
                        <div class="assistant-content" id="matematika-assistant-content"></div>
                        <button class="hint-btn" id="matematika-hint"><i class="fas fa-lightbulb"></i> Berikan Petunjuk</button>
                    </div>
                    <div class="navigation">
                        <button class="secondary" id="matematika-prev"><i class="fas fa-arrow-left"></i> Sebelumnya</button>
                        <div>
                            <button class="secondary" id="matematika-skip">Lewati <i class="fas fa-forward"></i></button>
                            <button id="matematika-next">Berikutnya <i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                </div>
                
                <!-- Layar Tes IPA -->
                <div class="screen" id="ipa">
                    <h2><i class="fas fa-flask"></i> Tes IPA</h2>
                    <div class="timer-box">
                        <div class="timer-section">
                            <div>Waktu Tersisa:</div>
                            <div class="timer" id="ipa-timer">30:00</div>
                            <div class="question-counter">Soal <span id="ipa-current">1</span> dari 15</div>
                            <div class="progress-bar"><div class="progress" id="ipa-progress"></div></div>
                        </div>
                        <div class="question-numbers" id="ipa-numbers"></div>
                    </div>
                    <div class="question-box">
                        <div class="question-text" id="ipa-question"></div>
                        <div class="options" id="ipa-options"></div>
                    </div>
                    <div class="assistant-panel" id="ipa-assistant">
                        <div class="assistant-header"><i class="fas fa-robot"></i><h4>Asisten IPA</h4></div>
                        <div class="assistant-content" id="ipa-assistant-content"></div>
                        <button class="hint-btn" id="ipa-hint"><i class="fas fa-lightbulb"></i> Berikan Petunjuk</button>
                    </div>
                    <div class="navigation">
                        <button class="secondary" id="ipa-prev"><i class="fas fa-arrow-left"></i> Sebelumnya</button>
                        <div>
                            <button class="secondary" id="ipa-skip">Lewati <i class="fas fa-forward"></i></button>
                            <button id="ipa-next">Berikutnya <i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                </div>
                
                <!-- Layar Tes Bahasa Indonesia -->
                <div class="screen" id="bahasa-indonesia">
                    <h2><i class="fas fa-book"></i> Tes Bahasa Indonesia</h2>
                    <div class="timer-box">
                        <div class="timer-section">
                            <div>Waktu Tersisa:</div>
                            <div class="timer" id="bahasa-indonesia-timer">30:00</div>
                            <div class="question-counter">Soal <span id="bahasa-indonesia-current">1</span> dari 15</div>
                            <div class="progress-bar"><div class="progress" id="bahasa-indonesia-progress"></div></div>
                        </div>
                        <div class="question-numbers" id="bahasa-indonesia-numbers"></div>
                    </div>
                    <div class="question-box">
                        <div class="question-text" id="bahasa-indonesia-question"></div>
                        <div class="options" id="bahasa-indonesia-options"></div>
                    </div>
                    <div class="assistant-panel" id="bahasa-indonesia-assistant">
                        <div class="assistant-header"><i class="fas fa-robot"></i><h4>Asisten Bahasa Indonesia</h4></div>
                        <div class="assistant-content" id="bahasa-indonesia-assistant-content"></div>
                        <button class="hint-btn" id="bahasa-indonesia-hint"><i class="fas fa-lightbulb"></i> Berikan Petunjuk</button>
                    </div>
                    <div class="navigation">
                        <button class="secondary" id="bahasa-indonesia-prev"><i class="fas fa-arrow-left"></i> Sebelumnya</button>
                        <div>
                            <button class="secondary" id="bahasa-indonesia-skip">Lewati <i class="fas fa-forward"></i></button>
                            <button id="bahasa-indonesia-next">Berikutnya <i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                </div>
                
                <!-- Layar Tes Bahasa Inggris -->
                <div class="screen" id="english">
                    <h2><i class="fas fa-language"></i> Tes Bahasa Inggris</h2>
                    <div class="timer-box">
                        <div class="timer-section">
                            <div>Waktu Tersisa:</div>
                            <div class="timer" id="english-timer">30:00</div>
                            <div class="question-counter">Soal <span id="english-current">1</span> dari 15</div>
                            <div class="progress-bar"><div class="progress" id="english-progress"></div></div>
                        </div>
                        <div class="question-numbers" id="english-numbers"></div>
                    </div>
                    <div class="question-box">
                        <div class="question-text" id="english-question"></div>
                        <div class="options" id="english-options"></div>
                    </div>
                    <div class="assistant-panel" id="english-assistant">
                        <div class="assistant-header"><i class="fas fa-robot"></i><h4>English Assistant</h4></div>
                        <div class="assistant-content" id="english-assistant-content"></div>
                        <button class="hint-btn" id="english-hint"><i class="fas fa-lightbulb"></i> Give a Hint</button>
                    </div>
                    <div class="navigation">
                        <button class="secondary" id="english-prev"><i class="fas fa-arrow-left"></i> Previous</button>
                        <div>
                            <button class="secondary" id="english-skip">Skip <i class="fas fa-forward"></i></button>
                            <button id="english-next">Next <i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                </div>
                
                <!-- Layar Hasil Tes -->
                <div class="screen" id="results">
                    <h2><i class="fas fa-chart-bar"></i> Hasil Simulasi TKA</h2>
                    <div class="result-summary">
                        <p><strong>Nama:</strong> <span id="result-name"></span></p>
                        <p><strong>Sekolah:</strong> <span id="result-school"></span></p>
                        <p><strong>Kelas:</strong> <span id="result-class"></span></p>
                        <p><strong>Mata Pelajaran:</strong> <span id="result-subject"></span></p>
                        <p><strong>Tanggal:</strong> <span id="result-date"></span></p>
                        <p><strong>Mode:</strong> <span id="result-mode"></span></p>
                        <div class="score-display">
                            <div class="score-circle"><div class="score-inner"><span id="total-score">0</span></div></div>
                            <h3>Skor Total: <span id="score-text">0</span>/100</h3>
                            <p id="score-message"></p>
                        </div>
                        <div class="subject-results" id="result-subject-results"></div>
                    </div>
                    <div class="result-details">
                        <h3>Detail Jawaban:</h3>
                        <div id="results-details"></div>
                    </div>
                    <div class="navigation">
                        <button class="secondary" id="restart-test"><i class="fas fa-redo"></i> Tes Ulang</button>
                        <button id="back-to-welcome"><i class="fas fa-home"></i> Kembali ke Beranda</button>
                        <button id="save-result"><i class="fas fa-save"></i> Simpan Nilai</button>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2023 Simulasi TKA dengan Sistem Manajemen Sekolah • Aplikasi untuk guru dan siswa</p>
            <p>Disusun berdasarkan materi pelajaran sesuai kurikulum nasional</p>
        </footer>
    </div>

    <script>
        // ==================== BANK SOAL LENGKAP (DIPERBAIKI) ====================
        // Setiap soal memiliki jawaban yang benar (0-index) dan penjelasan
        const questionsData = {
            "6sd": {
                matematika: [
                    { question: "Hasil dari 125 + 75 × 2 adalah...", options: ["400", "275", "325", "200"], answer: 1, explanation: "Perkalian dikerjakan terlebih dahulu: 75 × 2 = 150, kemudian 125 + 150 = 275" },
                    { question: "Faktorisasi prima dari 36 adalah...", options: ["2² × 3²", "2 × 3²", "2² × 3", "2 × 3³"], answer: 0, explanation: "36 = 2 × 2 × 3 × 3 = 2² × 3²" },
                    { question: "KPK dari 8 dan 12 adalah...", options: ["16", "24", "32", "48"], answer: 1, explanation: "Kelipatan 8: 8,16,24,32... Kelipatan 12: 12,24,36... KPK = 24" },
                    { question: "Luas segitiga dengan alas 10 cm dan tinggi 6 cm adalah...", options: ["30 cm²", "60 cm²", "16 cm²", "32 cm²"], answer: 0, explanation: "L = ½ × alas × tinggi = ½ × 10 × 6 = 30 cm²" },
                    { question: "Nilai dari 2³ adalah...", options: ["6", "8", "9", "4"], answer: 1, explanation: "2³ = 2 × 2 × 2 = 8" },
                    { question: "Urutan pecahan dari yang terkecil: 1/3, 1/2, 2/5, 3/4 adalah...", options: ["1/3, 2/5, 1/2, 3/4", "1/2, 1/3, 2/5, 3/4", "1/3, 1/2, 2/5, 3/4", "3/4, 1/2, 2/5, 1/3"], answer: 0, explanation: "Desimal: 0.33, 0.4, 0.5, 0.75" },
                    { question: "Hasil dari 3,5 × 2 adalah...", options: ["6", "7", "6.5", "7.5"], answer: 1, explanation: "3,5 × 2 = 7" },
                    { question: "Keliling persegi dengan sisi 8 cm adalah...", options: ["16 cm", "24 cm", "32 cm", "64 cm"], answer: 2, explanation: "K = 4 × s = 4 × 8 = 32 cm" },
                    { question: "Bilangan romawi untuk 27 adalah...", options: ["XXV", "XXVII", "XXII", "XXX"], answer: 1, explanation: "XX = 20, VII = 7, jadi XXVII = 27" },
                    { question: "Hasil dari 5² + 3³ adalah...", options: ["34", "52", "16", "28"], answer: 1, explanation: "5²=25, 3³=27, 25+27=52" },
                    { question: "Volume kubus dengan rusuk 4 cm adalah...", options: ["16 cm³", "64 cm³", "24 cm³", "32 cm³"], answer: 1, explanation: "V = s³ = 4³ = 64 cm³" },
                    { question: "Hasil dari 2/3 + 1/6 adalah...", options: ["3/9", "5/6", "1/2", "3/6"], answer: 1, explanation: "2/3 = 4/6, 4/6+1/6=5/6" },
                    { question: "Bentuk desimal dari 3/5 adalah...", options: ["0.3", "0.5", "0.6", "0.8"], answer: 2, explanation: "3/5 = 0.6" },
                    { question: "FPB dari 18 dan 24 adalah...", options: ["3", "6", "9", "12"], answer: 1, explanation: "Faktor 18:1,2,3,6,9,18. Faktor 24:1,2,3,4,6,8,12,24. FPB = 6" },
                    { question: "Nilai dari 20% dari 150 adalah...", options: ["20", "30", "40", "50"], answer: 1, explanation: "20/100 × 150 = 30" }
                ],
                ipa: [
                    { question: "Planet terdekat dari matahari adalah...", options: ["Venus", "Mars", "Merkurius", "Bumi"], answer: 2, explanation: "Merkurius adalah planet terdekat dari matahari" },
                    { question: "Fotosintesis menghasilkan...", options: ["Oksigen dan air", "Oksigen dan glukosa", "Karbondioksida dan air", "Karbondioksida dan glukosa"], answer: 1, explanation: "Fotosintesis: CO₂ + H₂O + cahaya → C₆H₁₂O₆ + O₂" },
                    { question: "Bagian mata yang mengatur cahaya masuk adalah...", options: ["Retina", "Kornea", "Iris", "Lensa"], answer: 2, explanation: "Iris mengatur pupil untuk banyak sedikitnya cahaya" },
                    { question: "Hewan dengan metamorfosis sempurna...", options: ["Kupu-kupu", "Kecoa", "Belalang", "Jangkrik"], answer: 0, explanation: "Kupu-kupu: telur → ulat → kepompong → dewasa" },
                    { question: "Enzim yang mengubah protein menjadi pepton...", options: ["Mulut", "Lambung", "Usus halus", "Usus besar"], answer: 1, explanation: "Lambung menghasilkan pepsin yang mengubah protein menjadi pepton" },
                    { question: "Penyakit akibat kekurangan vitamin C...", options: ["Rabun senja", "Beriberi", "Skorbut", "Rakitis"], answer: 2, explanation: "Skorbut adalah penyakit kekurangan vitamin C" },
                    { question: "Perubahan gas menjadi cair disebut...", options: ["Menguap", "Menyublim", "Mengembun", "Membeku"], answer: 2, explanation: "Gas → cair = mengembun" },
                    { question: "Energi alternatif dari panas bumi...", options: ["Biomassa", "Geothermal", "Hidrotermal", "Biofuel"], answer: 1, explanation: "Geothermal = panas bumi" },
                    { question: "Alat kelamin jantan pada bunga...", options: ["Putik", "Benang sari", "Mahkota", "Kelopak"], answer: 1, explanation: "Benang sari adalah alat kelamin jantan" },
                    { question: "Gerak tumbuhan menuju cahaya...", options: ["Geotropisme", "Hidrotropisme", "Fototropisme", "Tigmotropisme"], answer: 2, explanation: "Fototropisme = gerak menuju cahaya" },
                    { question: "Hewan ovipar adalah...", options: ["Kucing", "Anjing", "Ayam", "Sapi"], answer: 2, explanation: "Ayam berkembang biak dengan bertelur" },
                    { question: "Zat hijau daun disebut...", options: ["Klorofil", "Kloroplas", "Xantofil", "Karoten"], answer: 0, explanation: "Klorofil adalah zat hijau daun" },
                    { question: "Alat pernapasan ikan...", options: ["Paru-paru", "Insang", "Kulit", "Trakea"], answer: 1, explanation: "Ikan bernapas dengan insang" },
                    { question: "Penyakit rakitis akibat kekurangan vitamin...", options: ["A", "B", "C", "D"], answer: 3, explanation: "Vitamin D untuk kesehatan tulang" },
                    { question: "Bagian telinga yang menangkap gelombang suara...", options: ["Daun telinga", "Gendang telinga", "Koklea", "Saluran eustachius"], answer: 0, explanation: "Daun telinga berfungsi menangkap suara" }
                ],
                "bahasa-indonesia": [
                    { question: "Penggunaan tanda koma yang benar...", options: ["Ibu membeli, apel jeruk dan mangga", "Ibu membeli apel, jeruk, dan mangga", "Ibu, membeli apel jeruk dan mangga", "Ibu membeli apel jeruk, dan mangga"], answer: 1, explanation: "Koma memisahkan unsur dalam deret" },
                    { question: "Kata tanya untuk alasan...", options: ["Apa", "Mengapa", "Bagaimana", "Di mana"], answer: 1, explanation: "Mengapa menanyakan alasan/sebab" },
                    { question: "Sinonim rajin adalah...", options: ["Malas", "Giat", "Lambat", "Cepat"], answer: 1, explanation: "Rajin = giat" },
                    { question: "Huruf kapital yang benar...", options: ["Ibu pergi ke pasar senen", "Ibu pergi ke Pasar Senen", "Ibu pergi ke pasar Senen", "ibu pergi ke Pasar Senen"], answer: 1, explanation: "Nama tempat diawali huruf kapital" },
                    { question: "Kalimat opini...", options: ["Indonesia merdeka 17 Agustus 1945", "Jakarta ibu kota Indonesia", "Bali pulau paling indah di Indonesia", "Gunung Semeru di Jawa Timur"], answer: 2, explanation: "Opini adalah pendapat pribadi" },
                    { question: "Imbuhan 'ter-' bermakna paling...", options: ["Tertawa", "Terbaik", "Terbawa", "Terjatuh"], answer: 1, explanation: "Terbaik = paling baik" },
                    { question: "Antonim awal adalah...", options: ["Pertama", "Akhir", "Tengah", "Mulai"], answer: 1, explanation: "Awal lawannya akhir" },
                    { question: "Kata depan 'di' yang benar...", options: ["Dina pergi di sekolah", "Buku itu diletakkan diatas meja", "Kucing itu tidur di bawah meja", "Mereka bermain di halaman sekolah"], answer: 3, explanation: "'di' sebagai kata depan ditulis terpisah untuk tempat" },
                    { question: "Kata baku yang tepat...", options: ["Saya apresiasi prestasimu", "Kami mengapresiasi prestasimu", "Kita harus menghargai prestasi mereka", "Dia memberikan apresiasi terhadap prestasi kami"], answer: 2, explanation: "Menghargai adalah bentuk baku" },
                    { question: "Paragraf narasi adalah...", options: ["Menjelaskan proses", "Menggambarkan objek", "Menceritakan peristiwa", "Memaparkan pendapat"], answer: 2, explanation: "Narasi menceritakan suatu kejadian" },
                    { question: "Penulisan kata yang benar...", options: ["Nasehat", "Naschat", "Nasihat", "Nasehat"], answer: 2, explanation: "Menurut KBBI: nasihat" },
                    { question: "Ejaan yang tepat...", options: ["Ibu membeli obat di apotik", "Kakak pergi ke sekolah naik sepedah", "Adik sedang belajar matematika", "Ayah membaca koran setiap pagi"], answer: 3, explanation: "Kalimat D sudah tepat ejaannya" },
                    { question: "Kata 'kemarin' tepat dalam kalimat...", options: ["Saya akan pergi kemarin", "Besok adalah hari kemarin", "Kemarin saya pergi ke sekolah", "Saya sedang pergi kemarin"], answer: 2, explanation: "Kemarin menyatakan waktu lampau" },
                    { question: "Kata tidak baku...", options: ["Ijazah", "Ijazah", "Ijasah", "Izajah"], answer: 2, explanation: "Baku: ijazah, tidak baku: ijasah" },
                    { question: "Penggunaan tanda seru yang tepat...", options: ["Wah, indah sekali pemandangan ini!", "Wah indah sekali pemandangan ini", "Wah! indah sekali pemandangan ini", "Wah indah sekali pemandangan ini!"], answer: 0, explanation: "Tanda seru setelah kalimat seruan" }
                ]
            },
            "2smp": {
                matematika: [
                    { question: "Hasil dari (2x + 3)(x - 4) adalah...", options: ["2x² - 5x - 12", "2x² + 5x - 12", "2x² - 5x + 12", "2x² + 5x + 12"], answer: 0, explanation: "(2x+3)(x-4)=2x²-8x+3x-12=2x²-5x-12" },
                    { question: "Nilai x dari 3x - 7 = 14 adalah...", options: ["5", "6", "7", "8"], answer: 2, explanation: "3x = 21 → x = 7" },
                    { question: "Bentuk sederhana √72...", options: ["6√2", "3√8", "8√3", "2√18"], answer: 0, explanation: "√72 = √(36×2)=6√2" },
                    { question: "Gradien garis y = 2x - 5...", options: ["-5", "2", "-2", "5"], answer: 1, explanation: "y = mx + c, m = 2" },
                    { question: "Himpunan penyelesaian x² - 5x + 6 = 0...", options: ["{2,3}", "{-2,-3}", "{1,6}", "{-1,-6}"], answer: 0, explanation: "(x-2)(x-3)=0 → x=2 atau x=3" },
                    { question: "Nilai log 100...", options: ["1", "2", "10", "100"], answer: 1, explanation: "log 100 = log 10² = 2" },
                    { question: "Sisi miring segitiga 6 cm dan 8 cm...", options: ["10 cm", "12 cm", "14 cm", "16 cm"], answer: 0, explanation: "√(6²+8²)=√100=10" },
                    { question: "Volume bola jari-jari 7 cm... (π=22/7)", options: ["1437.33 cm³", "1796.33 cm³", "2155.33 cm³", "2514.33 cm³"], answer: 0, explanation: "V = 4/3 πr³ = 4/3 × 22/7 × 343 ≈ 1437.33" },
                    { question: "Nilai sin 30°...", options: ["1/2", "√3/2", "√2/2", "1"], answer: 0, explanation: "sin 30° = 1/2" },
                    { question: "Jika f(x)=2x+3, f(4)=...", options: ["8", "9", "10", "11"], answer: 3, explanation: "f(4)=2×4+3=11" },
                    { question: "Jumlah sudut segitiga...", options: ["90°", "180°", "270°", "360°"], answer: 1, explanation: "Jumlah sudut segitiga 180°" },
                    { question: "Fungsi y=x²-4x+3 memotong sumbu x di...", options: ["(1,0) dan (3,0)", "(-1,0) dan (3,0)", "(1,0) dan (-3,0)", "(-1,0) dan (-3,0)"], answer: 0, explanation: "x²-4x+3=(x-1)(x-3)=0" },
                    { question: "Nilai 2⁻³...", options: ["-8", "-6", "1/8", "1/6"], answer: 2, explanation: "2⁻³ = 1/2³ = 1/8" },
                    { question: "Diagonal sisi kubus rusuk 10 cm...", options: ["10√2 cm", "10√3 cm", "20 cm", "10 cm"], answer: 0, explanation: "Diagonal sisi = s√2" },
                    { question: "Rata-rata 5,7,8,6,9...", options: ["6", "6.5", "7", "7.5"], answer: 2, explanation: "(5+7+8+6+9)/5 = 35/5 = 7" }
                ],
                ipa: [
                    { question: "Hukum kekekalan energi menyatakan...", options: ["Energi dapat diciptakan", "Energi dapat dimusnahkan", "Energi tidak dapat diciptakan/dimusnahkan", "Energi hanya dapat berubah bentuk"], answer: 2, explanation: "Energi bersifat kekal" },
                    { question: "GLBB memiliki...", options: ["Kecepatan tetap", "Percepatan tetap", "Kecepatan nol", "Percepatan nol"], answer: 1, explanation: "Gerak lurus berubah beraturan = percepatan tetap" },
                    { question: "Enzim pengubah amilum menjadi maltosa...", options: ["Pepsin", "Amilase", "Lipase", "Tripsin"], answer: 1, explanation: "Amilase pada air liur mengubah amilum menjadi maltosa" },
                    { question: "Sistem peredaran darah tertutup ditemukan pada...", options: ["Serangga", "Cacing tanah", "Manusia", "Udang"], answer: 2, explanation: "Vertebrata memiliki peredaran darah tertutup" },
                    { question: "Hukum Newton I disebut juga...", options: ["Aksi-reaksi", "Percepatan", "Kelembaman", "Gravitasi"], answer: 2, explanation: "Hukum inersia (kelembaman)" },
                    { question: "Organel tempat respirasi sel...", options: ["Inti sel", "Mitokondria", "Ribosom", "Retikulum endoplasma"], answer: 1, explanation: "Mitokondria adalah the powerhouse of the cell" },
                    { question: "Bahan yang menghantarkan listrik baik...", options: ["Isolator", "Konduktor", "Semikonduktor", "Superkonduktor"], answer: 1, explanation: "Konduktor, contoh: tembaga" },
                    { question: "Penyakit yang disebabkan virus...", options: ["TBC", "Malaria", "Demam berdarah", "Tifus"], answer: 2, explanation: "DBD disebabkan virus dengue" },
                    { question: "Besi berkarat termasuk perubahan...", options: ["Fisika", "Kimia", "Biologi", "Alam"], answer: 1, explanation: "Perubahan kimia (terbentuk zat baru)" },
                    { question: "Perkembangbiakan dengan umbi batang contohnya...", options: ["Wortel", "Kentang", "Bawang merah", "Jahe"], answer: 1, explanation: "Kentang adalah umbi batang" },
                    { question: "Sistem pertahanan tubuh disebut...", options: ["Pencernaan", "Pernapasan", "Imun", "Sirkulasi"], answer: 2, explanation: "Sistem imun" },
                    { question: "Pembelahan sel untuk sel gamet...", options: ["Mitosis", "Meiosis", "Amitosis", "Sitokinesis"], answer: 1, explanation: "Meiosis menghasilkan sel haploid (gamet)" },
                    { question: "Gaya tarik molekul sejenis...", options: ["Adhesi", "Kohesi", "Kapilaritas", "Gravitasi"], answer: 1, explanation: "Kohesi antar molekul sejenis" },
                    { question: "Alat optik dengan dua lensa cembung...", options: ["Lup", "Mikroskop", "Teropong bintang", "Kamera"], answer: 1, explanation: "Mikroskop menggunakan lensa okuler dan objektif" },
                    { question: "Planet terbesar dalam tata surya...", options: ["Bumi", "Jupiter", "Saturnus", "Neptunus"], answer: 1, explanation: "Jupiter adalah planet terbesar" }
                ],
                "bahasa-indonesia": [
                    { question: "Kata 'apabila' yang tepat...", options: ["Apabila kamu belajar, maka kamu akan pandai", "Kamu apabila belajar, maka kamu akan pandai", "Kamu belajar apabila, maka kamu akan pandai", "Kamu belajar, maka kamu akan pandai apabila"], answer: 0, explanation: "Konjungsi syarat di awal kalimat" },
                    { question: "Kata yang mengalami peyorasi...", options: ["Wanita", "Bini", "Perempuan", "Ibu"], answer: 1, explanation: "Bini memiliki makna lebih rendah dari istri" },
                    { question: "Majas metafora...", options: ["Dia bekerja keras seperti semut", "Raja siang mulai bersinar", "Suaranya menggelegar bagai halilintar", "Wajahnya cantik laksana bidadari"], answer: 1, explanation: "Raja siang = matahari (perbandingan langsung)" },
                    { question: "Paragraf eksposisi...", options: ["Menceritakan pengalaman", "Menggambarkan objek", "Memaparkan informasi", "Berisi ajakan"], answer: 2, explanation: "Eksposisi memaparkan fakta/informasi" },
                    { question: "Kata serapan yang benar dari 'system'...", options: ["System", "Sistem", "Sistim", "Sistim"], answer: 1, explanation: "Penyerapan: sistem" },
                    { question: "Konjungsi antarkalimat...", options: ["Dia belajar keras sehingga lulus", "Meskipun hujan, dia tetap pergi", "Ayah membaca sambil minum kopi", "Dia rajin belajar. Oleh karena itu, dia pandai"], answer: 3, explanation: "Oleh karena itu adalah konjungsi antarkalimat" },
                    { question: "Kata yang mengalami ameliorasi...", options: ["Pramuniaga", "Pelayan", "Pembantu", "Babu"], answer: 0, explanation: "Pramuniaga lebih halus dari pelayan" },
                    { question: "Kata depan 'pada' yang tepat...", options: ["Buku itu berada pada meja", "Pada hari Senin kita upacara", "Dia datang pada pukul tujuh", "Pada musim hujan banyak nyamuk"], answer: 1, explanation: "Pada untuk waktu, bukan tempat" },
                    { question: "Biografi adalah...", options: ["Cerpen", "Novel", "Riwayat hidup seseorang", "Otobiografi"], answer: 2, explanation: "Biografi ditulis oleh orang lain" },
                    { question: "Diksi yang tepat...", options: ["Dia sangat gemar membaca buku", "Dia sangat hobi membaca buku", "Dia sangat sukai membaca buku", "Dia sangat senangi membaca buku"], answer: 0, explanation: "Gemar lebih formal dari hobi" },
                    { question: "Unsur intrinsik watak tokoh...", options: ["Tema", "Alur", "Tokoh", "Penokohan"], answer: 3, explanation: "Penokohan adalah penggambaran watak" },
                    { question: "Eufemisme untuk 'mati'...", options: ["Meninggal dunia", "Mati", "Wafat", "Berpulang"], answer: 0, explanation: "Meninggal dunia adalah ungkapan halus" },
                    { question: "Karangan yang mempengaruhi pembaca...", options: ["Narasi", "Deskripsi", "Eksposisi", "Argumentasi"], answer: 3, explanation: "Argumentasi bertujuan meyakinkan" },
                    { question: "Perluasan makna kata...", options: ["Sastra", "Kepala", "Bapak", "Sarjana"], answer: 2, explanation: "Bapak dari ayah menjadi sebutan hormat" },
                    { question: "Pleonasme adalah...", options: ["Dia naik ke atas tangga", "Dia turun ke bawah", "Mereka saling pukul memukul", "Semua jawaban benar"], answer: 3, explanation: "Semua mengandung kata berlebihan" }
                ],
                "english": [
                    { question: "She ____ to school every day.", options: ["go", "goes", "going", "went"], answer: 1, explanation: "Simple Present, she + goes" },
                    { question: "I have ____ English book.", options: ["a", "an", "the", "-"], answer: 1, explanation: "an untuk vowel sound" },
                    { question: "They ____ watching TV now.", options: ["is", "am", "are", "be"], answer: 2, explanation: "Present Continuous, they are" },
                    { question: "Past tense of 'go'...", options: ["goed", "went", "gone", "goes"], answer: 1, explanation: "go → went (irregular)" },
                    { question: "This book is ____ than that one.", options: ["good", "better", "best", "more good"], answer: 1, explanation: "Comparative: better" },
                    { question: "If I ____ rich, I would buy a big house.", options: ["am", "was", "were", "be"], answer: 2, explanation: "Conditional type 2: if + past (were)" },
                    { question: "She ____ her homework yesterday.", options: ["do", "does", "did", "done"], answer: 2, explanation: "Past tense: did" },
                    { question: "How ____ money do you have?", options: ["much", "many", "some", "any"], answer: 0, explanation: "Much untuk uncountable (money)" },
                    { question: "He is the ____ student in class.", options: ["tall", "taller", "tallest", "most tall"], answer: 2, explanation: "Superlative: tallest" },
                    { question: "I ____ my keys. Can you help me find them?", options: ["lose", "lost", "have lost", "am losing"], answer: 2, explanation: "Present Perfect: have lost" },
                    { question: "She enjoys ____ novels.", options: ["read", "reads", "to read", "reading"], answer: 3, explanation: "Enjoy + V-ing" },
                    { question: "____ you like some coffee?", options: ["Do", "Would", "Will", "Are"], answer: 1, explanation: "Would you like = offering politely" },
                    { question: "The cat is sleeping ____ the table.", options: ["on", "in", "at", "under"], answer: 3, explanation: "Under the table" },
                    { question: "He ____ to Japan three times.", options: ["has been", "have been", "was", "is"], answer: 0, explanation: "Present Perfect experience: has been" },
                    { question: "This is ____ book. It's not yours.", options: ["my", "mine", "me", "I"], answer: 0, explanation: "Possessive adjective: my" }
                ]
            },
            "3smp": {
                matematika: [
                    { question: "Nilai x dari 2x² - 5x - 3 = 0...", options: ["-1/2 dan 3", "1/2 dan -3", "-1/2 dan -3", "1/2 dan 3"], answer: 0, explanation: "(2x+1)(x-3)=0 → x=-1/2 atau x=3" },
                    { question: "Diketahui f(x)=3x-2, g(x)=x²+1. (f∘g)(2)=...", options: ["13", "11", "9", "7"], answer: 0, explanation: "g(2)=5, f(5)=13" },
                    { question: "Suku ke-10 barisan 2,5,8,11,...", options: ["29", "30", "31", "32"], answer: 0, explanation: "a=2,b=3 → U10=2+9×3=29" },
                    { question: "sin 60° cos 30° + cos 60° sin 30° = ...", options: ["1", "√3/2", "1/2", "0"], answer: 0, explanation: "sin(60+30)=sin90°=1" },
                    { question: "log 2=0.3010, log 3=0.4771, log 18 = ...", options: ["1.2552", "1.4771", "1.6532", "1.7781"], answer: 0, explanation: "log 18 = log(2×3²) = 0.3010 + 2×0.4771 = 1.2552" },
                    { question: "Turunan f(x)=3x⁴-2x²+5x-1...", options: ["12x³-4x+5", "12x³-4x²+5", "12x³-2x+5", "12x³-4x+5x"], answer: 0, explanation: "f'(x)=12x³-4x+5" },
                    { question: "Luas daerah y=x²-4x+3 dan sumbu x...", options: ["4/3", "2", "8/3", "4"], answer: 2, explanation: "∫₁³ (x²-4x+3) dx = 8/3" },
                    { question: "lim(x→2) (x²-4)/(x-2) = ...", options: ["0", "2", "4", "tidak ada"], answer: 2, explanation: "(x-2)(x+2)/(x-2)=x+2 → 4" },
                    { question: "Vektor a=(2,-1,3), b=(1,2,-2). a·b = ...", options: ["-6", "-2", "2", "6"], answer: 0, explanation: "2×1 + (-1)×2 + 3×(-2) = 2-2-6=-6" },
                    { question: "Persamaan lingkaran pusat (2,-3) jari-jari 5...", options: ["(x-2)²+(y+3)²=25", "(x+2)²+(y-3)²=25", "(x-2)²+(y-3)²=25", "(x+2)²+(y+3)²=25"], answer: 0, explanation: "(x-a)²+(y-b)²=r²" },
                    { question: "cos 120° = ...", options: ["-1/2", "1/2", "-√3/2", "√3/2"], answer: 0, explanation: "cos(180-60) = -cos60 = -1/2" },
                    { question: "Probabilitas muncul angka pada koin...", options: ["1/4", "1/3", "1/2", "2/3"], answer: 2, explanation: "Ruang sampel {A,G}, P(A)=1/2" },
                    { question: "Determinan matriks A = [[2,1],[3,4]]...", options: ["5", "6", "7", "8"], answer: 0, explanation: "2×4 - 1×3 = 8-3=5" },
                    { question: "∫(3x² - 2x + 1) dx = ...", options: ["x³ - x² + x + C", "x³ - 2x² + x + C", "3x³ - x² + x + C", "x³ - x² + 3x + C"], answer: 0, explanation: "∫3x² = x³, ∫-2x = -x², ∫1 = x" },
                    { question: "Sisa pembagian 2x³-5x²+3x-1 oleh (x-2)...", options: ["1", "2", "3", "4"], answer: 0, explanation: "f(2)=16-20+6-1=1" }
                ],
                ipa: [
                    { question: "Hukum Faraday tentang induksi...", options: ["GGL ~ laju perubahan fluks", "Arus listrik menghasilkan medan magnet", "Muatan listrik kekal", "Energi listrik ~ kuadrat arus"], answer: 0, explanation: "Hukum Faraday: ε = -dΦ/dt" },
                    { question: "Pada reaksi redoks, oksidasi adalah...", options: ["Melepaskan elektron", "Menerima elektron", "Melepaskan proton", "Menerima proton"], answer: 0, explanation: "Oksidasi = kehilangan elektron" },
                    { question: "Organ ekskresi manusia, kecuali...", options: ["Ginjal", "Paru-paru", "Hati", "Lambung"], answer: 3, explanation: "Lambung adalah organ pencernaan" },
                    { question: "Reaksi terang fotosintesis terjadi di...", options: ["Stroma", "Grana", "Membran tilakoid", "Sitoplasma"], answer: 1, explanation: "Grana adalah tumpukan tilakoid" },
                    { question: "Hukum Hardy-Weinberg...", options: ["Populasi besar, kawin acak, tanpa seleksi", "Populasi kecil, kawin tidak acak, ada seleksi", "Ada mutasi, migrasi", "Isolasi reproduksi"], answer: 0, explanation: "Syarat kesetimbangan Hardy-Weinberg" },
                    { question: "Enzim pembentuk ATP dalam respirasi...", options: ["ATP sintase", "ATPase", "Amilase", "Katalase"], answer: 0, explanation: "ATP sintase di mitokondria" },
                    { question: "Meiosis terjadi pada...", options: ["Sel somatik", "Sel gamet", "Sel saraf", "Sel epitel"], answer: 1, explanation: "Meiosis menghasilkan gamet" },
                    { question: "Hukum kekekalan massa dikemukakan oleh...", options: ["Lavoisier", "Dalton", "Avogadro", "Boyle"], answer: 0, explanation: "Antoine Lavoisier" },
                    { question: "Fotosistem I dan II berperan dalam...", options: ["Siklus Calvin", "Reaksi terang", "Fotorespirasi", "Respirasi aerob"], answer: 1, explanation: "Reaksi terang fotosintesis" },
                    { question: "Mekanisme evolusi Darwin...", options: ["Seleksi alam", "Mutasi acak", "Pewarisan sifat", "Isolasi geografis"], answer: 0, explanation: "Seleksi alam adalah mekanisme utama" },
                    { question: "Golongan IA disebut...", options: ["Alkali", "Alkali tanah", "Halogen", "Gas mulia"], answer: 0, explanation: "Logam alkali (Li, Na, K, dll)" },
                    { question: "Hukum Mendel I (segregasi)...", options: ["Alel berpisah saat pembentukan gamet", "Gen diwariskan independen", "Dominan menutupi resesif", "Fenotipe hasil genotipe & lingkungan"], answer: 0, explanation: "Hukum segregasi" },
                    { question: "Dekomposer dalam rantai makanan...", options: ["Produsen", "Konsumen I", "Konsumen II", "Pengurai"], answer: 3, explanation: "Pengurai menguraikan sisa organik" },
                    { question: "Model atom modern didasarkan pada...", options: ["Dalton", "Thomson", "Rutherford", "Bohr"], answer: 3, explanation: "Model atom Bohr dengan mekanika kuantum" },
                    { question: "Sistem koordinasi manusia...", options: ["Saraf dan hormon", "Saraf dan pencernaan", "Hormon dan pernapasan", "Peredaran darah dan saraf"], answer: 0, explanation: "Sistem saraf dan endokrin" }
                ],
                "bahasa-indonesia": [
                    { question: "Genre puisi baru adalah...", options: ["Pantun", "Syair", "Soneta", "Gurindam"], answer: 2, explanation: "Soneta adalah puisi baru 14 baris" },
                    { question: "Kata 'daripada' yang tepat...", options: ["Daripada tidak belajar, lebih baik belajar", "Tingginya daripada saya", "Dia datang daripada rumah", "Buku itu berada daripada meja"], answer: 0, explanation: "Daripada untuk membandingkan pilihan" },
                    { question: "Karangan deskripsi bertujuan...", options: ["Menceritakan", "Menggambarkan objek", "Memaparkan informasi", "Mempengaruhi"], answer: 1, explanation: "Deskripsi menggambarkan secara detail" },
                    { question: "Unsur ekstrinsik karya sastra, kecuali...", options: ["Latar belakang pengarang", "Nilai sosial budaya", "Alur cerita", "Kondisi masyarakat"], answer: 2, explanation: "Alur adalah unsur intrinsik" },
                    { question: "Sinestesia adalah...", options: ["Kata pedas (rasa→kritik)", "Kata manis (rasa→karakter)", "Kata dingin (suhu→sikap)", "Kata tajam (raba→pikiran)"], answer: 3, explanation: "Perubahan makna antar indera" },
                    { question: "Kalimat inversi...", options: ["Dia pergi ke sekolah", "Pergilah dia ke sekolah", "Ke sekolah dia pergi", "Dia ke sekolah pergi"], answer: 1, explanation: "Predikat mendahului subjek" },
                    { question: "Drama yang mengkritik dengan humor...", options: ["Tragedi", "Komedi", "Melodrama", "Satire"], answer: 3, explanation: "Satire adalah sindiran halus" },
                    { question: "Kata ulang berimbuan...", options: ["Buku-buku", "Main-main", "Berjalan-jalan", "Rumah-rumahan"], answer: 2, explanation: "Ber- + jalan + ulang" },
                    { question: "Gaya bahasa metafora...", options: ["Perbandingan tanpa kata pembanding", "Perbandingan dengan kata seperti", "Penggambaran benda mati hidup", "Pelebihan"], answer: 0, explanation: "Metafora: perbandingan langsung" },
                    { question: "Struktur teks prosedur...", options: ["Orientasi-komplikasi-resolusi", "Tesis-argumentasi-penegasan", "Pernyataan umum-deskripsi", "Tujuan-material-langkah-penutup"], answer: 3, explanation: "Tujuan, bahan, langkah, penutup" },
                    { question: "Majas litotes...", options: ["Dia setinggi gunung", "Suaranya menggelegar", "Mampirlah ke gubuk kami", "Waktunya berjalan lambat"], answer: 2, explanation: "Merendahkan diri (gubuk untuk rumah)" },
                    { question: "Alur sorot balik (flashback)...", options: ["Alur maju", "Alur mundur", "Alur campuran", "Alur kilas balik"], answer: 3, explanation: "Menampilkan peristiwa masa lalu" },
                    { question: "Perluasan makna kata...", options: ["Sastra", "Kepala", "Bapak", "Sarjana"], answer: 2, explanation: "Bapak → panggilan hormat" },
                    { question: "Diksi konotasi positif...", options: ["Anak emas", "Kambing hitam", "Gajah putih", "Tangan panjang"], answer: 0, explanation: "Anak emas = kesayangan" },
                    { question: "Teks yang mempengaruhi dengan data...", options: ["Narasi", "Deskripsi", "Eksposisi", "Argumentasi"], answer: 3, explanation: "Argumentasi menggunakan fakta/logika" }
                ],
                "english": [
                    { question: "If I ____ you, I would study harder.", options: ["am", "was", "were", "be"], answer: 2, explanation: "Conditional type 2: were untuk semua subjek" },
                    { question: "The book ____ I bought yesterday is interesting.", options: ["who", "whom", "which", "whose"], answer: 2, explanation: "Which untuk benda" },
                    { question: "She ____ here since 2010.", options: ["lives", "lived", "has lived", "is living"], answer: 2, explanation: "Present Perfect Continuous: has lived" },
                    { question: "I wish I ____ taller.", options: ["am", "was", "were", "be"], answer: 2, explanation: "Wish + past subjunctive (were)" },
                    { question: "He was made ____ the report again.", options: ["write", "to write", "writing", "written"], answer: 1, explanation: "Passive causative: was made + to infinitive" },
                    { question: "Not only ____ clever, but he is also kind.", options: ["he is", "is he", "does he", "he does"], answer: 1, explanation: "Inversi: Not only + auxiliary + subject" },
                    { question: "I'd rather you ____ here.", options: ["stay", "stayed", "to stay", "staying"], answer: 1, explanation: "I'd rather + subject + past tense" },
                    { question: "By next year, she ____ her degree.", options: ["will complete", "will have completed", "has completed", "completes"], answer: 1, explanation: "Future Perfect: will have completed" },
                    { question: "Had I known, I ____ you.", options: ["would help", "would have helped", "helped", "had helped"], answer: 1, explanation: "Conditional type 3: would have + V3" },
                    { question: "The teacher suggested that the student ____ more carefully.", options: ["reads", "read", "to read", "reading"], answer: 1, explanation: "Subjunctive: suggest + that + V1" },
                    { question: "____ he study hard, he will pass the exam.", options: ["Should", "If", "Unless", "Provided"], answer: 1, explanation: "If clause type 1" },
                    { question: "I object to ____ treated like a child.", options: ["be", "being", "been", "have been"], answer: 1, explanation: "Preposition + gerund (being)" },
                    { question: "Hardly ____ arrived when it started to rain.", options: ["we had", "had we", "we have", "have we"], answer: 1, explanation: "Inversi: Hardly + had + subject" },
                    { question: "The report needs ____ by tomorrow.", options: ["complete", "to complete", "completing", "completed"], answer: 2, explanation: "Need + V-ing (passive meaning)" },
                    { question: "Were she ____, she would help us.", options: ["here", "was here", "is here", "has been here"], answer: 0, explanation: "Were + subject + complement (inversi)" }
                ]
            }
        };

        // ==================== SISTEM PENYIMPANAN DATA ====================
        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        function generateSchoolCode() { const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let code = ''; for (let i = 0; i < 6; i++) code += chars.charAt(Math.floor(Math.random() * chars.length)); return code; }
        function getStorageData(key) { const data = localStorage.getItem(key); return data ? JSON.parse(data) : null; }
        function setStorageData(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
        function initializeSchoolData() {
            if (!getStorageData('tka_schools')) setStorageData('tka_schools', {});
            if (!getStorageData('tka_students')) setStorageData('tka_students', {});
            if (!getStorageData('tka_results')) setStorageData('tka_results', {});
        }
        initializeSchoolData();

        // Fungsi pendaftaran sekolah (case-insensitive untuk pengecekan nama)
        function registerSchool(schoolName, teacherPassword) {
            const schools = getStorageData('tka_schools');
            // Cek nama sekolah (case insensitive)
            for (let code in schools) {
                if (schools[code].name.toLowerCase() === schoolName.trim().toLowerCase()) {
                    return { success: false, message: 'Sekolah sudah terdaftar' };
                }
            }
            const schoolCode = generateSchoolCode();
            schools[schoolCode] = {
                id: schoolCode,
                name: schoolName.trim(),
                teacherPassword: teacherPassword,
                createdAt: new Date().toISOString(),
                students: []
            };
            setStorageData('tka_schools', schools);
            return { success: true, schoolCode: schoolCode };
        }

        // Fungsi login guru (case-insensitive untuk nama sekolah)
        function teacherLogin(schoolName, password) {
            const schools = getStorageData('tka_schools');
            for (let code in schools) {
                if (schools[code].name.toLowerCase() === schoolName.trim().toLowerCase()) {
                    if (schools[code].teacherPassword === password) {
                        return { success: true, schoolCode: code, schoolData: schools[code] };
                    } else {
                        return { success: false, message: 'Password salah' };
                    }
                }
            }
            return { success: false, message: 'Sekolah tidak ditemukan' };
        }

        // Fungsi login murid (nama sekolah case-insensitive, bisa pakai kode)
        function studentLogin(schoolName, studentName, schoolCode = null) {
            const schools = getStorageData('tka_schools');
            const students = getStorageData('tka_students');
            let foundSchoolCode = null;
            let foundSchool = null;

            if (schoolCode && schoolCode.trim() !== '') {
                if (schools[schoolCode.trim()]) {
                    foundSchoolCode = schoolCode.trim();
                    foundSchool = schools[foundSchoolCode];
                }
            } else if (schoolName && schoolName.trim() !== '') {
                for (let code in schools) {
                    if (schools[code].name.toLowerCase() === schoolName.trim().toLowerCase()) {
                        foundSchoolCode = code;
                        foundSchool = schools[code];
                        break;
                    }
                }
            }

            if (!foundSchool) {
                return { success: false, message: 'Sekolah tidak ditemukan. Pastikan nama sekolah benar atau gunakan kode sekolah.' };
            }

            const studentId = `${foundSchoolCode}_${studentName.trim().toLowerCase().replace(/\s+/g, '_')}`;
            if (!students[studentId]) {
                students[studentId] = {
                    id: studentId,
                    name: studentName.trim(),
                    schoolCode: foundSchoolCode,
                    schoolName: foundSchool.name,
                    class: null,
                    createdAt: new Date().toISOString(),
                    results: {}
                };
                // Tambahkan ke daftar murid sekolah
                if (!foundSchool.students.includes(studentId)) {
                    foundSchool.students.push(studentId);
                    schools[foundSchoolCode] = foundSchool;
                    setStorageData('tka_schools', schools);
                }
                setStorageData('tka_students', students);
            }

            return {
                success: true,
                studentId: studentId,
                studentData: students[studentId],
                schoolCode: foundSchoolCode,
                schoolName: foundSchool.name
            };
        }

        // Fungsi menyimpan hasil tes
        function saveTestResult(studentId, classLevel, subject, score, correct, total, answers, mode) {
            const students = getStorageData('tka_students');
            const results = getStorageData('tka_results');
            if (!students[studentId]) return { success: false, message: 'Murid tidak ditemukan' };

            // Inisialisasi struktur hasil
            if (!students[studentId].results) students[studentId].results = {};
            if (!students[studentId].results[classLevel]) students[studentId].results[classLevel] = {};
            if (!students[studentId].results[classLevel][subject]) students[studentId].results[classLevel][subject] = [];

            const resultId = generateId();
            const testResult = {
                id: resultId,
                studentId: studentId,
                studentName: students[studentId].name,
                schoolCode: students[studentId].schoolCode,
                schoolName: students[studentId].schoolName,
                class: classLevel,
                subject: subject,
                score: score,
                correct: correct,
                total: total,
                answers: answers,
                mode: mode,
                date: new Date().toISOString()
            };

            // Simpan di data siswa
            students[studentId].results[classLevel][subject].push(testResult);
            if (!students[studentId].class) students[studentId].class = classLevel;

            // Simpan di koleksi hasil per sekolah
            if (!results[students[studentId].schoolCode]) results[students[studentId].schoolCode] = {};
            results[students[studentId].schoolCode][resultId] = testResult;

            setStorageData('tka_students', students);
            setStorageData('tka_results', results);
            return { success: true, resultId: resultId };
        }

        // Fungsi mendapatkan hasil sekolah
        function getSchoolResults(schoolCode) {
            const results = getStorageData('tka_results');
            return results[schoolCode] || {};
        }

        // Fungsi statistik sekolah
        function getSchoolStats(schoolCode) {
            const schools = getStorageData('tka_schools');
            const results = getStorageData('tka_results');
            if (!schools[schoolCode]) return null;
            const school = schools[schoolCode];
            const schoolResults = results[schoolCode] || {};
            let totalStudents = school.students ? school.students.length : 0;
            let totalTests = Object.keys(schoolResults).length;
            let totalScore = 0;
            let testCount = 0;
            for (let rid in schoolResults) { totalScore += schoolResults[rid].score; testCount++; }
            let averageScore = testCount > 0 ? Math.round(totalScore / testCount) : 0;
            return { schoolName: school.name, totalStudents, totalTests, averageScore, createdAt: school.createdAt };
        }

        // ==================== STATE APLIKASI ====================
        let state = {
            userRole: null,
            userSchoolCode: null,
            userSchoolName: null,
            userName: null,
            userId: null,
            selectedClass: null,
            currentScreen: 'mode-selection',
            currentSubject: null,
            currentQuestionIndex: 0,
            mode: 'simulation',
            answers: { matematika: Array(15).fill(null), ipa: Array(15).fill(null), "bahasa-indonesia": Array(15).fill(null), english: Array(15).fill(null) },
            timers: { matematika: 30 * 60, ipa: 30 * 60, "bahasa-indonesia": 30 * 60, english: 30 * 60 },
            timerIntervals: {},
            testStarted: { matematika: false, ipa: false, "bahasa-indonesia": false, english: false },
            progress: { matematika: 0, ipa: 0, "bahasa-indonesia": 0, english: 0 },
            currentTestResult: null
        };

        // ==================== FUNGSI UTILITAS UI ====================
        function showAlert(elementId, message, type = 'success') {
            const alertEl = document.getElementById(elementId);
            if (!alertEl) return;
            alertEl.textContent = message;
            alertEl.className = `alert ${type}`;
            alertEl.classList.add('show');
            setTimeout(() => alertEl.classList.remove('show'), 5000);
        }

        function changeScreen(screenId) {
            if (state.currentSubject && state.timerIntervals[state.currentSubject]) {
                clearInterval(state.timerIntervals[state.currentSubject]);
                delete state.timerIntervals[state.currentSubject];
            }
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) targetScreen.classList.add('active');
            state.currentScreen = screenId;
            if (screenId === 'teacher-dashboard') loadTeacherDashboard();
            else if (screenId === 'welcome') loadStudentWelcome();
            else if (screenId === 'results') loadResultsScreen();
        }

        function updateUserInfo() {
            const userInfo = document.getElementById('user-info');
            const roleDisplay = document.getElementById('user-role-display');
            const schoolDisplay = document.getElementById('user-school-display');
            const nameDisplay = document.getElementById('user-name-display');
            const nameValue = document.getElementById('user-name-value');
            if (state.userRole) {
                userInfo.style.display = 'block';
                roleDisplay.textContent = state.userRole === 'teacher' ? 'Guru' : 'Murid';
                schoolDisplay.textContent = state.userSchoolName || '-';
                if (state.userRole === 'student') {
                    nameDisplay.style.display = 'inline';
                    nameValue.textContent = state.userName || '-';
                } else nameDisplay.style.display = 'none';
            } else userInfo.style.display = 'none';
        }

        function updateSidebar() {
            const sidebar = document.getElementById('sidebar');
            const modeSelector = document.getElementById('mode-selector');
            const menuItems = document.getElementById('menu-items');
            if (state.userRole) {
                sidebar.style.display = 'block';
                if (state.userRole === 'student') {
                    modeSelector.innerHTML = `<h4><i class="fas fa-cogs"></i> Mode Belajar</h4><div class="mode-buttons">
                        <div class="mode-btn ${state.mode === 'simulation' ? 'active' : ''}" data-mode="simulation"><i class="fas fa-clock"></i> Simulasi</div>
                        <div class="mode-btn ${state.mode === 'learning' ? 'active' : ''}" data-mode="learning"><i class="fas fa-chalkboard-teacher"></i> Belajar</div></div>`;
                    let subjectMenu = '';
                    if (state.selectedClass === '6sd') {
                        subjectMenu = `<div class="menu-item" data-screen="matematika"><i class="fas fa-calculator"></i> Matematika</div>
                                       <div class="menu-item" data-screen="ipa"><i class="fas fa-flask"></i> IPA</div>
                                       <div class="menu-item" data-screen="bahasa-indonesia"><i class="fas fa-book"></i> Bahasa Indonesia</div>`;
                    } else {
                        subjectMenu = `<div class="menu-item" data-screen="matematika"><i class="fas fa-calculator"></i> Matematika</div>
                                       <div class="menu-item" data-screen="ipa"><i class="fas fa-flask"></i> IPA</div>
                                       <div class="menu-item" data-screen="bahasa-indonesia"><i class="fas fa-book"></i> Bahasa Indonesia</div>
                                       <div class="menu-item" data-screen="english"><i class="fas fa-language"></i> Bahasa Inggris</div>`;
                    }
                    menuItems.innerHTML = `<div class="menu-item ${state.currentScreen === 'welcome' ? 'active' : ''}" data-screen="welcome"><i class="fas fa-home"></i> Beranda</div>${subjectMenu}<div class="menu-item ${state.currentScreen === 'results' ? 'active' : ''}" data-screen="results"><i class="fas fa-chart-bar"></i> Hasil & Nilai</div>`;
                } else {
                    modeSelector.innerHTML = `<h4><i class="fas fa-user-tie"></i> Mode Guru</h4><p style="font-size:14px;color:#666;margin:5px 0 0;">Sekolah: ${state.userSchoolName}</p>`;
                    menuItems.innerHTML = `<div class="menu-item ${state.currentScreen === 'teacher-dashboard' ? 'active' : ''}" data-screen="teacher-dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</div>`;
                }
                // Event listener untuk menu
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.addEventListener('click', function (e) {
                        e.stopPropagation();
                        changeScreen(this.dataset.screen);
                    });
                });
                if (state.userRole === 'student') {
                    document.querySelectorAll('.mode-btn').forEach(btn => {
                        btn.addEventListener('click', function () {
                            state.mode = this.dataset.mode;
                            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                            this.classList.add('active');
                            if (['matematika', 'ipa', 'bahasa-indonesia', 'english'].includes(state.currentScreen)) {
                                const assist = document.getElementById(`${state.currentScreen}-assistant`);
                                if (state.mode === 'learning') assist.classList.add('show');
                                else assist.classList.remove('show');
                            }
                        });
                    });
                }
            } else sidebar.style.display = 'none';
        }

        // ==================== FUNGSI MURID ====================
        function loadStudentWelcome() {
            document.getElementById('welcome-name').textContent = state.userName;
            document.getElementById('welcome-name2').textContent = state.userName;
            document.getElementById('welcome-school').textContent = state.userSchoolName || '-';
            let classDisplay = '';
            if (state.selectedClass) {
                if (state.selectedClass === '6sd') classDisplay = 'Kelas 6 SD';
                else if (state.selectedClass === '2smp') classDisplay = 'Kelas 2 SMP';
                else if (state.selectedClass === '3smp') classDisplay = 'Kelas 3 SMP';
            } else classDisplay = 'Belum memilih kelas';
            document.getElementById('welcome-class').textContent = classDisplay;
            updateStudentProgress();
            loadStudentHistory();
            updateSubjectList();
        }

        function updateStudentProgress() {
            const results = getStorageData('tka_students')?.[state.userId]?.results || {};
            if (!state.selectedClass || !results[state.selectedClass]) {
                document.getElementById('total-progress').textContent = '0%';
                document.getElementById('average-score').textContent = '0';
                document.getElementById('completed-tests').textContent = '0';
                return;
            }
            const classResults = results[state.selectedClass];
            let totalTests = 0, totalScore = 0;
            for (let sub in classResults) {
                if (classResults[sub].length) {
                    totalTests += classResults[sub].length;
                    totalScore += classResults[sub][classResults[sub].length - 1].score;
                }
            }
            let avg = totalTests > 0 ? Math.round(totalScore / totalTests) : 0;
            let progress = totalTests > 0 ? Math.min(100, Math.round((totalTests / 4) * 100)) : 0;
            document.getElementById('total-progress').textContent = `${progress}%`;
            document.getElementById('average-score').textContent = avg;
            document.getElementById('completed-tests').textContent = totalTests;
        }

        function loadStudentHistory() {
            const results = getStorageData('tka_students')?.[state.userId]?.results || {};
            const historyDiv = document.getElementById('history-results');
            if (!state.selectedClass || !results[state.selectedClass]) {
                historyDiv.innerHTML = `<div class="subject-result"><i class="fas fa-info-circle"></i><h4>Belum ada riwayat</h4><p>Kerjakan tes pertama Anda</p></div>`;
                return;
            }
            const classResults = results[state.selectedClass];
            let html = '';
            let count = 0;
            for (let sub in classResults) {
                if (classResults[sub].length && count < 4) {
                    let last = classResults[sub][classResults[sub].length - 1];
                    let icon = sub === 'matematika' ? 'fa-calculator' : sub === 'ipa' ? 'fa-flask' : sub === 'english' ? 'fa-language' : 'fa-book';
                    let subName = sub === 'matematika' ? 'Matematika' : sub === 'ipa' ? 'IPA' : sub === 'bahasa-indonesia' ? 'Bahasa Indonesia' : 'Bahasa Inggris';
                    let scoreClass = last.score >= 80 ? 'correct' : last.score >= 60 ? 'skipped' : 'incorrect';
                    html += `<div class="subject-result"><i class="fas ${icon}"></i><h4>${subName}</h4><p>Nilai: <span class="${scoreClass}">${last.score}</span>/100</p><p>${last.correct} benar dari ${last.total} soal</p></div>`;
                    count++;
                }
            }
            if (html === '') html = `<div class="subject-result"><i class="fas fa-info-circle"></i><h4>Belum ada riwayat</h4><p>Kerjakan tes pertama Anda</p></div>`;
            historyDiv.innerHTML = html;
        }

        function updateSubjectList() {
            const list = document.getElementById('subject-list');
            list.innerHTML = '';
            let subjects = [];
            if (state.selectedClass === '6sd') {
                subjects = [
                    { id: 'matematika', name: 'Matematika', icon: 'fa-calculator' },
                    { id: 'ipa', name: 'IPA', icon: 'fa-flask' },
                    { id: 'bahasa-indonesia', name: 'Bahasa Indonesia', icon: 'fa-book' }
                ];
            } else {
                subjects = [
                    { id: 'matematika', name: 'Matematika', icon: 'fa-calculator' },
                    { id: 'ipa', name: 'IPA', icon: 'fa-flask' },
                    { id: 'bahasa-indonesia', name: 'Bahasa Indonesia', icon: 'fa-book' },
                    { id: 'english', name: 'Bahasa Inggris', icon: 'fa-language' }
                ];
            }
            subjects.forEach(sub => {
                let card = document.createElement('div');
                card.className = 'subject-card';
                card.dataset.subject = sub.id;
                card.innerHTML = `<i class="fas ${sub.icon}"></i><h3>${sub.name}</h3><p class="subject-info">15 soal • 30 menit</p><div class="progress-label">Progress: ${state.progress[sub.id]}%</div>`;
                card.addEventListener('click', function () {
                    state.answers[sub.id] = Array(15).fill(null);
                    state.currentSubject = sub.id;
                    state.currentQuestionIndex = 0;
                    loadQuestion(sub.id, 0);
                    createQuestionNumbers(sub.id);
                    let assist = document.getElementById(`${sub.id}-assistant`);
                    if (assist) {
                        if (state.mode === 'learning') assist.classList.add('show');
                        else assist.classList.remove('show');
                    }
                    if (state.mode === 'simulation' && !state.testStarted[sub.id]) {
                        startTimer(sub.id);
                        state.testStarted[sub.id] = true;
                    }
                    changeScreen(sub.id);
                });
                list.appendChild(card);
            });
        }

        // ==================== FUNGSI TES ====================
        function createQuestionNumbers(subject) {
            let container = document.getElementById(`${subject}-numbers`);
            if (!container) return;
            container.innerHTML = '';
            for (let i = 0; i < 15; i++) {
                let num = document.createElement('div');
                num.className = 'question-number';
                num.textContent = i + 1;
                num.dataset.index = i;
                if (state.answers[subject][i] !== null) num.classList.add('answered');
                if (i === state.currentQuestionIndex) num.classList.add('current');
                num.addEventListener('click', () => {
                    state.currentQuestionIndex = i;
                    loadQuestion(subject, i);
                    updateQuestionNumbers(subject);
                });
                container.appendChild(num);
            }
        }

        function updateQuestionNumbers(subject) {
            let nums = document.querySelectorAll(`#${subject}-numbers .question-number`);
            nums.forEach((n, i) => {
                n.classList.remove('current', 'answered');
                if (i === state.currentQuestionIndex) n.classList.add('current');
                if (state.answers[subject][i] !== null) n.classList.add('answered');
            });
        }

        function loadQuestion(subject, index) {
            if (!state.selectedClass || !questionsData[state.selectedClass] || !questionsData[state.selectedClass][subject]) {
                alert('Soal tidak tersedia untuk mata pelajaran ini. Silakan coba lagi.');
                return;
            }
            let q = questionsData[state.selectedClass][subject][index];
            if (!q) return;
            document.getElementById(`${subject}-question`).textContent = `${index + 1}. ${q.question}`;
            document.getElementById(`${subject}-current`).textContent = index + 1;
            let progress = ((index + 1) / 15) * 100;
            let progBar = document.getElementById(`${subject}-progress`);
            if (progBar) progBar.style.width = `${progress}%`;

            let opts = document.getElementById(`${subject}-options`);
            opts.innerHTML = '';
            q.options.forEach((opt, i) => {
                let optEl = document.createElement('div');
                optEl.className = 'option';
                if (state.answers[subject][index] === i) optEl.classList.add('selected');
                optEl.innerHTML = `<div class="option-label">${String.fromCharCode(65 + i)}</div><div class="option-text">${opt}</div>`;
                optEl.addEventListener('click', () => selectOption(subject, index, i));
                opts.appendChild(optEl);
            });
            if (state.mode === 'learning' && q.explanation) {
                document.getElementById(`${subject}-assistant-content`).textContent = q.explanation;
            }
            let prevBtn = document.getElementById(`${subject}-prev`);
            if (prevBtn) prevBtn.disabled = index === 0;
            let nextBtn = document.getElementById(`${subject}-next`);
            if (nextBtn) {
                if (index === 14) {
                    nextBtn.innerHTML = `<i class="fas fa-flag-checkered"></i> Selesai`;
                    nextBtn.onclick = () => finishTest(subject);
                } else {
                    nextBtn.innerHTML = subject === 'english' ? `Next <i class="fas fa-arrow-right"></i>` : `Berikutnya <i class="fas fa-arrow-right"></i>`;
                    nextBtn.onclick = () => nextQuestion(subject);
                }
            }
        }

        function selectOption(subject, qIndex, optIndex) {
            state.answers[subject][qIndex] = optIndex;
            let opts = document.querySelectorAll(`#${subject}-options .option`);
            opts.forEach((opt, i) => {
                if (i === optIndex) opt.classList.add('selected');
                else opt.classList.remove('selected');
                if (state.mode === 'learning') {
                    let correct = questionsData[state.selectedClass][subject][qIndex].answer;
                    if (i === correct) opt.classList.add('correct');
                    else opt.classList.remove('correct');
                    if (i === optIndex && i !== correct) opt.classList.add('incorrect');
                    else opt.classList.remove('incorrect');
                }
            });
            updateQuestionNumbers(subject);
        }

        function giveHint(subject) {
            let q = questionsData[state.selectedClass][subject][state.currentQuestionIndex];
            if (q && q.explanation) {
                document.getElementById(`${subject}-assistant-content`).textContent = `Petunjuk: ${q.explanation}`;
            }
        }

        function nextQuestion(subject) {
            if (state.currentQuestionIndex < 14) {
                state.currentQuestionIndex++;
                loadQuestion(subject, state.currentQuestionIndex);
                updateQuestionNumbers(subject);
            }
        }

        function prevQuestion(subject) {
            if (state.currentQuestionIndex > 0) {
                state.currentQuestionIndex--;
                loadQuestion(subject, state.currentQuestionIndex);
                updateQuestionNumbers(subject);
            }
        }

        function skipQuestion(subject) {
            state.answers[subject][state.currentQuestionIndex] = null;
            updateQuestionNumbers(subject);
            if (state.currentQuestionIndex < 14) {
                state.currentQuestionIndex++;
                loadQuestion(subject, state.currentQuestionIndex);
                updateQuestionNumbers(subject);
            }
        }

        function startTimer(subject) {
            if (state.timerIntervals[subject]) clearInterval(state.timerIntervals[subject]);
            if (state.timers[subject] <= 0) state.timers[subject] = 30 * 60;
            updateTimerDisplay(subject);
            state.timerIntervals[subject] = setInterval(() => {
                state.timers[subject]--;
                updateTimerDisplay(subject);
                if (state.timers[subject] <= 0) {
                    clearInterval(state.timerIntervals[subject]);
                    finishTest(subject);
                }
            }, 1000);
        }

        function updateTimerDisplay(subject) {
            let mins = Math.floor(state.timers[subject] / 60);
            let secs = state.timers[subject] % 60;
            let timerEl = document.getElementById(`${subject}-timer`);
            if (timerEl) {
                timerEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                timerEl.style.color = state.timers[subject] < 300 ? '#f44336' : '#1a6dcc';
            }
        }

        function finishTest(subject) {
            if (state.timerIntervals[subject]) {
                clearInterval(state.timerIntervals[subject]);
                delete state.timerIntervals[subject];
            }
            calculateTestResult(subject);
            changeScreen('results');
        }

        function calculateTestResult(subject) {
            let qs = questionsData[state.selectedClass][subject];
            let correct = 0;
            for (let i = 0; i < 15; i++) {
                if (state.answers[subject][i] === qs[i].answer) correct++;
            }
            let score = Math.round((correct / 15) * 100);
            state.currentTestResult = {
                subject, score, correct, total: 15,
                answers: [...state.answers[subject]],
                class: state.selectedClass, mode: state.mode
            };
        }

        function loadResultsScreen() {
            if (!state.currentTestResult) return;
            let res = state.currentTestResult;
            document.getElementById('result-name').textContent = state.userName || '-';
            document.getElementById('result-school').textContent = state.userSchoolName || '-';
            let cls = res.class;
            let clsName = cls === '6sd' ? 'Kelas 6 SD' : cls === '2smp' ? 'Kelas 2 SMP' : 'Kelas 3 SMP';
            document.getElementById('result-class').textContent = clsName;
            let subName = res.subject === 'matematika' ? 'Matematika' : res.subject === 'ipa' ? 'IPA' : res.subject === 'bahasa-indonesia' ? 'Bahasa Indonesia' : 'Bahasa Inggris';
            document.getElementById('result-subject').textContent = subName;
            document.getElementById('result-date').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('result-mode').textContent = res.mode === 'simulation' ? 'Mode Simulasi' : 'Mode Belajar';
            document.getElementById('total-score').textContent = res.score;
            document.getElementById('score-text').textContent = res.score;
            let msg = document.getElementById('score-message');
            if (res.score >= 85) { msg.textContent = "Sangat baik!"; msg.style.color = "#4CAF50"; }
            else if (res.score >= 70) { msg.textContent = "Baik, tingkatkan!"; msg.style.color = "#FF9800"; }
            else if (res.score >= 60) { msg.textContent = "Cukup, belajar lagi."; msg.style.color = "#FF9800"; }
            else { msg.textContent = "Perlu belajar lebih giat."; msg.style.color = "#f44336"; }
            let icon = res.subject === 'matematika' ? 'fa-calculator' : res.subject === 'ipa' ? 'fa-flask' : res.subject === 'english' ? 'fa-language' : 'fa-book';
            document.getElementById('result-subject-results').innerHTML = `<div class="subject-result"><i class="fas ${icon}"></i><h4>${subName}</h4><p>Nilai: <span>${res.score}</span>/100</p><p>${res.correct} benar dari 15 soal</p></div>`;
            let qs = questionsData[res.class][res.subject];
            let details = document.getElementById('results-details');
            details.innerHTML = '';
            for (let i = 0; i < 15; i++) {
                let d = document.createElement('div');
                d.className = 'detail-item';
                let correct = res.answers[i] === qs[i].answer;
                let skipped = res.answers[i] === null;
                let status = skipped ? 'Tidak dijawab' : correct ? 'Benar' : 'Salah';
                let statusClass = skipped ? 'skipped' : correct ? 'correct' : 'incorrect';
                d.innerHTML = `<div>Soal ${i+1}: ${qs[i].question.substring(0,60)}...</div><div class="${statusClass}">${status}</div>`;
                details.appendChild(d);
            }
            // Tombol simpan aktif
            let saveBtn = document.getElementById('save-result');
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Simpan Nilai';
        }

        function saveTestResultToSystem() {
            if (!state.currentTestResult || !state.userId) {
                showAlert('results', 'Gagal menyimpan', 'error');
                return;
            }
            let r = state.currentTestResult;
            let save = saveTestResult(state.userId, r.class, r.subject, r.score, r.correct, r.total, r.answers, r.mode);
            if (save.success) {
                showAlert('results', 'Hasil tes berhasil disimpan', 'success');
                document.getElementById('save-result').disabled = true;
                document.getElementById('save-result').innerHTML = '<i class="fas fa-check"></i> Tersimpan';
                // Update progress
                updateStudentProgress();
                loadStudentHistory();
            } else {
                showAlert('results', 'Gagal menyimpan: ' + save.message, 'error');
            }
        }

        // ==================== FUNGSI GURU ====================
        function loadTeacherDashboard() {
            if (!state.userSchoolCode) return;
            let stats = getSchoolStats(state.userSchoolCode);
            if (stats) {
                document.getElementById('stat-school-name').textContent = stats.schoolName;
                document.getElementById('stat-total-students').textContent = stats.totalStudents;
                document.getElementById('stat-total-tests').textContent = stats.totalTests;
                document.getElementById('stat-average-score').textContent = stats.averageScore;
                document.getElementById('school-code-display').textContent = state.userSchoolCode;
                document.getElementById('edit-school-name').value = stats.schoolName;
            }
            loadStudentResults();
        }

        function loadStudentResults() {
            let results = getSchoolResults(state.userSchoolCode);
            let listDiv = document.getElementById('student-results-list');
            if (!listDiv) return;
            let filterClass = document.getElementById('filter-class')?.value || 'all';
            let filterSubject = document.getElementById('filter-subject')?.value || 'all';
            let filterSort = document.getElementById('filter-sort')?.value || 'name';
            let arr = Object.values(results);
            if (filterClass !== 'all') arr = arr.filter(r => r.class === filterClass);
            if (filterSubject !== 'all') arr = arr.filter(r => r.subject === filterSubject);
            if (filterSort === 'name') arr.sort((a,b) => a.studentName.localeCompare(b.studentName));
            else if (filterSort === 'score-desc') arr.sort((a,b) => b.score - a.score);
            else if (filterSort === 'score-asc') arr.sort((a,b) => a.score - b.score);
            else if (filterSort === 'date-desc') arr.sort((a,b) => new Date(b.date) - new Date(a.date));
            listDiv.innerHTML = '';
            if (arr.length === 0) {
                listDiv.innerHTML = '<div class="student-row" style="text-align:center;padding:40px;"><div style="grid-column:1/span5;">Belum ada data nilai murid</div></div>';
                return;
            }
            arr.forEach(r => {
                let row = document.createElement('div');
                row.className = 'student-row';
                let cls = r.class === '6sd' ? 'Kelas 6 SD' : r.class === '2smp' ? 'Kelas 2 SMP' : 'Kelas 3 SMP';
                let sub = r.subject === 'matematika' ? 'Matematika' : r.subject === 'ipa' ? 'IPA' : r.subject === 'bahasa-indonesia' ? 'Bahasa Indonesia' : 'Bahasa Inggris';
                let date = new Date(r.date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                let scoreClass = r.score >= 80 ? 'high' : r.score >= 60 ? 'medium' : 'low';
                row.innerHTML = `<div class="student-name">${r.studentName}</div><div>${cls}</div><div>${sub}</div><div class="student-score ${scoreClass}">${r.score}</div><div>${date}</div>`;
                listDiv.appendChild(row);
            });
        }

        function updateSchoolData() {
            let name = document.getElementById('edit-school-name').value.trim();
            let pass = document.getElementById('edit-teacher-password').value.trim();
            if (!name) { showAlert('teacher-dashboard-alert', 'Nama sekolah tidak boleh kosong', 'error'); return; }
            let schools = getStorageData('tka_schools');
            if (!schools[state.userSchoolCode]) { showAlert('teacher-dashboard-alert', 'Sekolah tidak ditemukan', 'error'); return; }
            schools[state.userSchoolCode].name = name;
            if (pass) schools[state.userSchoolCode].teacherPassword = pass;
            setStorageData('tka_schools', schools);
            state.userSchoolName = name;
            updateUserInfo();
            updateSidebar();
            showAlert('teacher-dashboard-alert', 'Data sekolah berhasil diperbarui', 'success');
            loadTeacherDashboard();
        }

        function exportSchoolData() {
            let results = getSchoolResults(state.userSchoolCode);
            let students = getStorageData('tka_students') || {};
            let schoolStudents = {};
            for (let id in students) if (students[id].schoolCode === state.userSchoolCode) schoolStudents[id] = students[id];
            let data = { schoolCode: state.userSchoolCode, schoolName: state.userSchoolName, exportDate: new Date().toISOString(), students: schoolStudents, results };
            let blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            let url = URL.createObjectURL(blob);
            let a = document.createElement('a');
            a.href = url;
            a.download = `data-nilai-${state.userSchoolCode}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showAlert('teacher-dashboard-alert', 'Data berhasil diekspor', 'success');
        }

        // ==================== EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', function () {
            // Mode selection
            document.querySelectorAll('.class-card[data-mode]').forEach(card => {
                card.addEventListener('click', function (e) {
                    let mode = this.dataset.mode;
                    if (mode === 'student') changeScreen('student-login');
                    else if (mode === 'teacher') changeScreen('teacher-login');
                });
            });
            document.getElementById('back-to-mode')?.addEventListener('click', () => changeScreen('mode-selection'));
            document.getElementById('back-to-mode2')?.addEventListener('click', () => changeScreen('mode-selection'));

            // Student login
            document.getElementById('student-login-btn')?.addEventListener('click', function () {
                let schoolName = document.getElementById('student-school-input').value.trim();
                let studentName = document.getElementById('student-name-input').value.trim();
                let schoolCode = document.getElementById('student-code-input').value.trim();
                if (!schoolName && !schoolCode) { showAlert('student-alert', 'Masukkan nama sekolah atau kode sekolah', 'error'); return; }
                if (!studentName) { showAlert('student-alert', 'Masukkan nama lengkap', 'error'); return; }
                let login = studentLogin(schoolName, studentName, schoolCode || null);
                if (login.success) {
                    state.userRole = 'student';
                    state.userId = login.studentId;
                    state.userName = studentName;
                    state.userSchoolCode = login.schoolCode;
                    state.userSchoolName = login.schoolName;
                    updateUserInfo();
                    updateSidebar();
                    document.getElementById('class-selection-name').textContent = studentName;
                    changeScreen('class-selection');
                } else {
                    showAlert('student-alert', login.message, 'error');
                }
            });

            // Pilih kelas
            document.querySelectorAll('.class-card[data-class]').forEach(card => {
                card.addEventListener('click', function () {
                    document.querySelectorAll('.class-card[data-class]').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    state.selectedClass = this.dataset.class;
                });
            });
            document.getElementById('confirm-class')?.addEventListener('click', function () {
                if (!state.selectedClass) { alert('Silakan pilih kelas!'); return; }
                let students = getStorageData('tka_students');
                if (students[state.userId]) {
                    students[state.userId].class = state.selectedClass;
                    setStorageData('tka_students', students);
                }
                changeScreen('welcome');
            });
            document.getElementById('back-to-student-login')?.addEventListener('click', () => changeScreen('student-login'));

            // Teacher login
            document.getElementById('teacher-login-btn')?.addEventListener('click', function () {
                let name = document.getElementById('teacher-school-input').value.trim();
                let pass = document.getElementById('teacher-password-input').value.trim();
                if (!name) { showAlert('teacher-alert', 'Masukkan nama sekolah', 'error'); return; }
                if (!pass) { showAlert('teacher-alert', 'Masukkan password guru', 'error'); return; }
                let login = teacherLogin(name, pass);
                if (login.success) {
                    state.userRole = 'teacher';
                    state.userSchoolCode = login.schoolCode;
                    state.userSchoolName = login.schoolData.name;
                    updateUserInfo();
                    updateSidebar();
                    changeScreen('teacher-dashboard');
                } else {
                    showAlert('teacher-alert', login.message, 'error');
                }
            });
            document.getElementById('teacher-register-btn')?.addEventListener('click', function () {
                let name = document.getElementById('teacher-school-input').value.trim();
                let pass = document.getElementById('teacher-password-input').value.trim();
                if (!name) { showAlert('teacher-alert', 'Masukkan nama sekolah', 'error'); return; }
                if (!pass) { showAlert('teacher-alert', 'Masukkan password guru', 'error'); return; }
                let reg = registerSchool(name, pass);
                if (reg.success) {
                    state.userRole = 'teacher';
                    state.userSchoolCode = reg.schoolCode;
                    state.userSchoolName = name;
                    updateUserInfo();
                    updateSidebar();
                    showAlert('teacher-alert', `Sekolah berhasil didaftarkan! Kode: ${reg.schoolCode}`, 'success');
                    changeScreen('teacher-dashboard');
                } else {
                    showAlert('teacher-alert', reg.message, 'error');
                }
            });

            // Dashboard guru
            document.getElementById('update-school-btn')?.addEventListener('click', updateSchoolData);
            document.getElementById('export-data-btn')?.addEventListener('click', exportSchoolData);
            document.getElementById('refresh-dashboard-btn')?.addEventListener('click', function () {
                loadStudentResults();
                showAlert('teacher-dashboard-alert', 'Data nilai diperbarui', 'success');
            });
            document.getElementById('filter-class')?.addEventListener('change', loadStudentResults);
            document.getElementById('filter-subject')?.addEventListener('change', loadStudentResults);
            document.getElementById('filter-sort')?.addEventListener('change', loadStudentResults);

            // Logout
            document.getElementById('teacher-logout-btn')?.addEventListener('click', function () {
                state = { ...state, userRole: null, userSchoolCode: null, userSchoolName: null, userName: null, userId: null, selectedClass: null };
                changeScreen('mode-selection');
            });
            document.getElementById('student-logout-btn')?.addEventListener('click', function () {
                state = { ...state, userRole: null, userSchoolCode: null, userSchoolName: null, userName: null, userId: null, selectedClass: null };
                changeScreen('mode-selection');
            });

            // Tombol tes
            document.getElementById('matematika-prev')?.addEventListener('click', () => prevQuestion('matematika'));
            document.getElementById('matematika-skip')?.addEventListener('click', () => skipQuestion('matematika'));
            document.getElementById('matematika-hint')?.addEventListener('click', () => giveHint('matematika'));
            document.getElementById('ipa-prev')?.addEventListener('click', () => prevQuestion('ipa'));
            document.getElementById('ipa-skip')?.addEventListener('click', () => skipQuestion('ipa'));
            document.getElementById('ipa-hint')?.addEventListener('click', () => giveHint('ipa'));
            document.getElementById('bahasa-indonesia-prev')?.addEventListener('click', () => prevQuestion('bahasa-indonesia'));
            document.getElementById('bahasa-indonesia-skip')?.addEventListener('click', () => skipQuestion('bahasa-indonesia'));
            document.getElementById('bahasa-indonesia-hint')?.addEventListener('click', () => giveHint('bahasa-indonesia'));
            document.getElementById('english-prev')?.addEventListener('click', () => prevQuestion('english'));
            document.getElementById('english-skip')?.addEventListener('click', () => skipQuestion('english'));
            document.getElementById('english-hint')?.addEventListener('click', () => giveHint('english'));

            // Hasil
            document.getElementById('restart-test')?.addEventListener('click', function () {
                if (state.currentTestResult && state.currentTestResult.subject) {
                    let sub = state.currentTestResult.subject;
                    state.answers[sub] = Array(15).fill(null);
                    state.currentSubject = sub;
                    state.currentQuestionIndex = 0;
                    loadQuestion(sub, 0);
                    createQuestionNumbers(sub);
                    if (state.mode === 'learning') document.getElementById(`${sub}-assistant`)?.classList.add('show');
                    else document.getElementById(`${sub}-assistant`)?.classList.remove('show');
                    if (state.mode === 'simulation') { startTimer(sub); state.testStarted[sub] = true; }
                    changeScreen(sub);
                }
            });
            document.getElementById('back-to-welcome')?.addEventListener('click', () => changeScreen('welcome'));
            document.getElementById('save-result')?.addEventListener('click', saveTestResultToSystem);
        });
    </script>
</body>
    </html>
